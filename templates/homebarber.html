<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Catálogo de Trabajos - Barber Studio</title>
    <link rel="stylesheet" href="../static/homebarber.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
  </head>
  <body>
    <header class="header">
      <div class="block">
        <img
          class="imagen-de-barberia"
          src="../images/barber.jpg"
          alt="Logo Barber Studio"
        />
      </div>
      <nav class="navigation-pill-list" aria-label="Navegación principal">
        <a href="/perfil" class="navigation-pill">
          <span class="title">Mi Perfil</span>
        </a>
        <a href="/homebarber" class="navigation-pill">
          <span class="title">Inicio</span>
        </a>
        <a href="/barber_agenda" class="navigation-pill">
          <span class="">Agenda</span>
        </a>
        <a href="/notibarbero" class="navigation-pill">
          <span class="title">Notificaciones</span>
        </a>
        <a href="/" class="navigation-pill">
          <span class="title">Cerrar Sesión</span>
        </a>
      </nav>
    </header>
    <main class="main-content">
      <div class="modal" id="message-modal" style="display: none">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title" id="message-modal-title">Nuevo mensaje</h2>
            <button class="close-modal" id="close-message-modal">
              &times;
            </button>
          </div>
          <form id="message-form" class="upload-form">
            <input type="hidden" id="message-id" value="" />

            <div class="form-group">
              <label for="message-text">Mensaje</label>
              <textarea
                id="message-text"
                name="message-text"
                rows="4"
                maxlength="700"
                placeholder="Escribe aquí el mensaje que verán tus clientes"
                required
              ></textarea>
            </div>

            <div class="form-group">
              <label for="message-type">Tipo</label>
              <select id="message-type" name="message-type">
                <option value="info">Información</option>
                <option value="ocupado">Ocupado</option>
                <option value="trabajando">Trabajando</option>
              </select>
            </div>

            <div class="form-actions">
              <button
                type="button"
                class="btn btn-secondary"
                id="cancel-message"
              >
                Cancelar
              </button>
              <button type="submit" class="btn btn-primary">
                Guardar mensaje
              </button>
            </div>
          </form>
        </div>
      </div>
      <section class="messages-section">
        <div class="catalog-header">
          <h2 class="catalog-title">Mensajes para tus clientes</h2>
          <button class="btn btn-primary" id="add-message-btn">
            Nuevo mensaje
          </button>
        </div>

        <div class="messages-container" id="messages-container-barber">
          <!-- Se llena con JS -->
        </div>
      </section>

      <section class="catalog-section">
        <div class="catalog-header">
          <h2 class="catalog-title">Mis Trabajos</h2>
          <button class="btn btn-primary" id="add-image">
            Agregar Nuevo Trabajo
          </button>
        </div>

        <div class="catalog-container" id="catalog-container">
          <!-- Las tarjetas de imágenes se generarán con JavaScript -->
          <div class="empty-catalog" id="empty-catalog">
            <p>Aún no has agregado trabajos a tu catálogo.</p>
            <p>Haz clic en "Agregar Nuevo Trabajo" para comenzar.</p>
          </div>
        </div>
      </section>
    </main>

    <!-- Modal para agregar/editar imagen -->
    <div class="modal" id="upload-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="modal-title">
            Agregar Nuevo Trabajo al Catálogo
          </h2>
          <button class="close-modal" id="close-modal">&times;</button>
        </div>
        <form id="upload-form" class="upload-form">
          <input type="hidden" id="edit-id" name="edit-id" value="" />

          <div class="form-group">
            <label for="image-name">Nombre del Trabajo</label>
            <input
              type="text"
              id="image-name"
              name="image-name"
              placeholder="Ej: Corte Fade Moderno"
              required
            />
          </div>

          <div class="form-group">
            <label for="image-description">Descripción</label>
            <textarea
              id="image-description"
              name="image-description"
              rows="4"
              placeholder="Describe el trabajo realizado, técnicas utilizadas, etc."
            ></textarea>
          </div>

          <!-- ESTE CAMPO YA EXISTÍA, SOLO LO USAREMOS BIEN SEGÚN EL ROL -->
          <div class="form-group" id="barber-field-group" style="display: none">
            <label for="image-barber">Barbero (autor del corte)</label>
            <select id="image-barber" name="image-barber">
              <option value="Ivan Barber">Ivan Barber</option>
              <option value="de referencia">de referencia</option>
            </select>
            <p class="field-note">
              Nombre del barbero que realizó el corte (puede ser de referencia)
            </p>
          </div>

          <div class="form-group">
            <label for="image-file">Imagen</label>
            <input
              type="file"
              id="image-file"
              name="image-file"
              accept="image/*"
            />
            <img
              id="image-preview"
              class="image-preview"
              alt="Vista previa de la imagen"
            />
            <p class="image-note" id="image-note">
              Selecciona una imagen para subir
            </p>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="cancel-upload">
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary" id="submit-button">
              Guardar en Catálogo
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- NUEVO: Modal simple para editar la descripción de bienvenida -->
    <div class="modal" id="welcome-modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Editar descripción de bienvenida</h2>
          <button class="close-modal" id="close-welcome-modal">&times;</button>
        </div>
        <form id="welcome-form" class="upload-form">
          <div class="form-group">
            <label for="welcome-textarea">Descripción</label>
            <textarea
              id="welcome-textarea"
              name="welcome-textarea"
              rows="4"
            ></textarea>
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="cancel-welcome">
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary">
              Guardar descripción
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal de confirmación para eliminar -->
    <div class="modal" id="delete-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Confirmar Eliminación</h2>
          <button class="close-modal" id="close-delete-modal">&times;</button>
        </div>
        <div class="delete-confirmation">
          <p>¿Estás seguro de que deseas eliminar este trabajo del catálogo?</p>
          <p><strong id="delete-item-name"></strong></p>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="cancel-delete">
              Cancelar
            </button>
            <button type="button" class="btn btn-danger" id="confirm-delete">
              Eliminar
            </button>
          </div>
        </div>
      </div>
    </div>

    <footer class="footer">
      <!-- TU FOOTER ORIGINAL TAL CUAL -->
      <div class="footer-logo">
        <img
          class="imagen-de-barberia"
          src="/barberpi/images/barber.jpg"
          alt="Barber Studio Logo"
        />
      </div>
      <nav class="text-link-list" aria-labelledby="footer-contact">
        <div class="text-strong-wrapper">
          <h2 id="footer-contact" class="text-strong">
            <span class="text-strong-2">contacto</span>
          </h2>
        </div>
        <ul class="footer-list">
          <li class="text-link-list-item">
            <a href="tel:9837324637" class="list-item">9837324637</a>
          </li>
          <li class="text-link-list-item">
            <a href="mailto:barberpi@utttn.mx" class="list-item-2"
              >barberpi@utttn.mx</a
            >
          </li>
        </ul>
      </nav>
      <nav class="text-link-list" aria-labelledby="footer-location">
        <div class="text-strong-wrapper">
          <h2 id="footer-location" class="text-strong">
            <span class="text-strong-2">ubicación</span>
          </h2>
        </div>
        <ul class="footer-list">
          <li class="text-link-list-item">
            <a
              href="https://maps.app.goo.gl/ZD5gur5vPiwKMVCW9?g_st=iw"
              target="_blank"
              rel="noopener noreferrer"
              class="list-item-7"
              >google.maps/micasa</a
            >
          </li>
        </ul>
      </nav>
      <nav class="text-link-list" aria-labelledby="footer-creator">
        <div class="text-strong-wrapper">
          <h2 id="footer-creator" class="text-strong">
            <span class="">creado por:</span>
          </h2>
        </div>
        <ul class="footer-list">
          <li class="text-link-list-item">
            <span class="list-item-11">Axel Rivera</span>
          </li>
          <li class="text-link-list-item">
            <span class="list-item-12">contactos:</span>
          </li>
          <li class="text-link-list-item">
            <a href="mailto:axel.delgado@uttn.mx" class="list-item-13"
              >axel.delgado@uttn.mx</a
            >
          </li>
          <li class="text-link-list-item">
            <a href="tel:8994287620" class="list-item">8994287620</a>
          </li>
        </ul>
      </nav>
    </footer>
    <script>
      const API_AUTH = "http://localhost:4000/api/auth";
      const API_CATALOG = "http://localhost:4000/api/catalogo";
      const API_MENSAJES = "http://localhost:4000/api/mensajes";

      function getToken() {
        return localStorage.getItem("token");
      }

      function getRol() {
        return localStorage.getItem("rol");
      }

      function redirigirSegunRol(rol) {
        switch (rol) {
          case "barbero":
          case "admin":
            window.location.href = "/barberpi/templates/homebarber.html";
            break;
          case "cliente":
          default:
            window.location.href = "/barberpi/templates/home.html";
            break;
        }
      }

      // Estado local sincronizado con la BD
      let catalogImages = [];
      let currentEditId = null;
      let itemToDelete = null;
      let currentUser = null;
      let currentRol = null;
      let mensajesBarbero = [];
      let currentMessageId = null;

      document.addEventListener("DOMContentLoaded", async () => {
        const token = getToken();
        const rol = getRol();
        currentRol = rol;

        // 1) Autenticación y rol
        if (!token) {
          alert("Debes iniciar sesión");
          window.location.href = "/barberpi/templates/login.html";
          return;
        }

        // Permitimos sólo barbero y admin en esta página
        if (rol !== "barbero" && rol !== "admin") {
          redirigirSegunRol(rol);
          return;
        }

        // 2) Cargar perfil
        try {
          const resp = await fetch(`${API_AUTH}/perfil`, {
            method: "GET",
            headers: { Authorization: `Bearer ${token}` },
          });

          if (resp.status === 401) {
            alert("Sesión expirada. Vuelve a iniciar sesión.");
            localStorage.removeItem("token");
            localStorage.removeItem("rol");
            window.location.href = "/barberpi/templates/login.html";
            return;
          }

          if (resp.ok) {
            const user = await resp.json();
            currentUser = user;

            const spanNombre = document.getElementById("nombre-usuario");
            if (spanNombre) spanNombre.textContent = user.nombre || "";

            // Si en el futuro traes una descripción personalizada desde el backend:
            // if (user.welcome_description) {
            //   const welcomeP = document.getElementById("welcome-text");
            //   if (welcomeP) welcomeP.textContent = user.welcome_description;
            // }
          }
        } catch (err) {
          console.error("Error al obtener perfil", err);
        }

        loadWelcomeDescription();
        // 3) Configurar eventos UI
        setupEventListeners();

        // 4) Configurar campo barbero según el rol
        configureBarberFieldByRole();

        // 5) Cargar trabajos reales desde el backend
        await loadCatalogFromServer();
        await loadMensajesBarbero();
        setupMensajesEvents();
      });

      async function loadMensajesBarbero() {
        const token = getToken();
        const container = document.getElementById("messages-container-barber");
        container.innerHTML = "<p>Cargando mensajes...</p>";

        try {
          const resp = await fetch(`${API_MENSAJES}/mis-mensajes`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!resp.ok) {
            const text = await resp.text();
            console.error("Error al cargar mensajes:", resp.status, text);
            container.innerHTML =
              "<p>No se pudieron cargar los mensajes. Intenta más tarde.</p>";
            return;
          }

          mensajesBarbero = await resp.json();
          renderMensajesBarbero();
        } catch (err) {
          console.error("Error conexión mensajes:", err);
          container.innerHTML =
            "<p>Error de conexión al cargar los mensajes.</p>";
        }
      }

      function renderMensajesBarbero() {
        const container = document.getElementById("messages-container-barber");
        container.innerHTML = "";

        if (!mensajesBarbero.length) {
          container.innerHTML = "<p>Aún no has creado mensajes.</p>";
          return;
        }

        mensajesBarbero.forEach((m) => {
          const card = document.createElement("div");
          card.className = "catalog-card"; // reutilizamos estilo de cartas

          const fecha = m.creado_en
            ? new Date(m.creado_en).toLocaleDateString("es-ES", {
                year: "numeric",
                month: "short",
                day: "numeric",
              })
            : "";

          card.innerHTML = `
      <div class="catalog-actions">
        <button class="action-btn edit-btn" data-id="${
          m.id_mensaje
        }" title="Editar">
          <i class="fa-solid fa-pen"></i>
        </button>
        <button class="action-btn delete-btn" data-id="${
          m.id_mensaje
        }" title="${"Borrar"}">
          <i class="fa-solid fa-trash"></i>
        </button>
      </div>
      <div class="catalog-info">
        <p class="catalog-description">${m.mensaje}</p>
        <p class="catalog-date">
          Tipo: ${m.tipo} ${fecha ? " · " + fecha : ""} ${
            m.activo ? "" : " · (inactivo)"
          }
        </p>
      </div>
    `;

          card
            .querySelector(".edit-btn")
            .addEventListener("click", () => openMessageModal(m));
          card
            .querySelector(".delete-btn")
            .addEventListener("click", () => toggleMensajeActivo(m));

          container.appendChild(card);
        });
      }

      function setupMensajesEvents() {
        const addBtn = document.getElementById("add-message-btn");
        const modal = document.getElementById("message-modal");
        const closeBtn = document.getElementById("close-message-modal");
        const cancelBtn = document.getElementById("cancel-message");
        const form = document.getElementById("message-form");

        if (addBtn) {
          addBtn.addEventListener("click", () => openMessageModal(null));
        }
        function closeModalMensaje() {
          if (modal) modal.style.display = "none";
          currentMessageId = null;
          form.reset();
        }

        if (closeBtn) closeBtn.addEventListener("click", closeModalMensaje);
        if (cancelBtn) cancelBtn.addEventListener("click", closeModalMensaje);

        if (form) {
          form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const text = document.getElementById("message-text").value.trim();
            const tipo = document.getElementById("message-type").value;

            if (!text) {
              alert("El mensaje no puede estar vacío.");
              return;
            }

            const token = getToken();

            try {
              let resp;
              if (currentMessageId) {
                resp = await fetch(`${API_MENSAJES}/${currentMessageId}`, {
                  method: "PUT",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                  },
                  body: JSON.stringify({ mensaje: text, tipo }),
                });
              } else {
                resp = await fetch(API_MENSAJES, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                  },
                  body: JSON.stringify({ mensaje: text, tipo }),
                });
              }

              const data = await resp.json();

              if (!resp.ok) {
                alert(data.error || "Error al guardar el mensaje");
                return;
              }

              await loadMensajesBarbero();
              closeModalMensaje();
            } catch (err) {
              console.error("Error guardando mensaje:", err);
              alert("Error de conexión al guardar el mensaje");
            }
          });
        }

        window.openMessageModal = function (mensaje) {
          const modal = document.getElementById("message-modal");
          const title = document.getElementById("message-modal-title");
          const textInput = document.getElementById("message-text");
          const typeSelect = document.getElementById("message-type");

          if (mensaje) {
            currentMessageId = mensaje.id_mensaje;
            title.textContent = "Editar mensaje";
            textInput.value = mensaje.mensaje;
            typeSelect.value = mensaje.tipo || "info";
          } else {
            currentMessageId = null;
            title.textContent = "Nuevo mensaje";
            textInput.value = "";
            typeSelect.value = "info";
          }

          modal.style.display = "flex";
        };

        window.toggleMensajeActivo = async function (mensaje) {
          const token = getToken();
          const nuevoEstado = !mensaje.activo;

          try {
            const resp = await fetch(
              `${API_MENSAJES}/${mensaje.id_mensaje}/activo`,
              {
                method: "PATCH",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ activo: nuevoEstado }),
              }
            );

            const data = await resp.json();
            if (!resp.ok) {
              alert(data.error || "Error al actualizar el estado del mensaje");
              return;
            }

            await loadMensajesBarbero();
          } catch (err) {
            console.error("Error cambiando estado mensaje:", err);
            alert("Error de conexión al actualizar el mensaje");
          }
        };
      }
      function loadWelcomeDescription() {
        const welcomeP = document.getElementById("welcome-text");
        if (welcomeP) {
          const saved = localStorage.getItem("welcome_description_global");
          if (saved && saved.trim() !== "") {
            welcomeP.textContent = saved;
          }
        }
      }

      function saveWelcomeDescription(newText) {
        if (!newText || newText.trim() === "") {
          alert("La descripción no puede estar vacía.");
          return false;
        }

        // Actualizar en la vista
        const welcomeP = document.getElementById("welcome-text");
        if (welcomeP) {
          welcomeP.textContent = newText;
        }

        // Guardar en localStorage como mensaje global
        localStorage.setItem("welcome_description_global", newText);

        return true;
      }

      function openWelcomeModal() {
        const modal = document.getElementById("welcome-modal");
        const textarea = document.getElementById("welcome-textarea");
        const p = document.getElementById("welcome-text");

        if (textarea && p) {
          textarea.value = p.textContent.trim();
        }
        if (modal) modal.style.display = "flex";
      }

      function closeWelcomeModal() {
        const modal = document.getElementById("welcome-modal");
        if (modal) modal.style.display = "none";
      }

      async function loadCatalogFromServer() {
        const token = getToken();
        try {
          const resp = await fetch(`${API_CATALOG}/mis-trabajos`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!resp.ok) {
            console.error("Error al obtener catálogo");
            return;
          }

          const data = await resp.json();
          catalogImages = data.map((item) => ({
            id: item.id_foto,
            name: item.nombre,
            description: item.descripcion || "",
            imageUrl: `http://localhost:4000${item.url_imagen}`,
            date: item.fecha_subida,
            nombre_barber: item.nombre_barber,
          }));

          renderCatalog();
        } catch (err) {
          console.error("Error de conexión al cargar catálogo", err);
        }
      }

      function setupEventListeners() {
        document
          .getElementById("add-image")
          .addEventListener("click", openAddModal);

        document
          .getElementById("close-modal")
          .addEventListener("click", closeUploadModal);

        document
          .getElementById("close-delete-modal")
          .addEventListener("click", closeDeleteModal);

        document
          .getElementById("cancel-upload")
          .addEventListener("click", closeUploadModal);

        document
          .getElementById("cancel-delete")
          .addEventListener("click", closeDeleteModal);

        // Vista previa de imagen
        document
          .getElementById("image-file")
          .addEventListener("change", function (e) {
            if (e.target.files && e.target.files[0]) {
              const reader = new FileReader();
              reader.onload = function (e2) {
                const preview = document.getElementById("image-preview");
                preview.src = e2.target.result;
                preview.style.display = "block";
                document.getElementById("image-note").textContent =
                  "Imagen seleccionada";
              };
              reader.readAsDataURL(e.target.files[0]);
            }
          });

        // Envío del formulario
        document
          .getElementById("upload-form")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            if (currentEditId) {
              updateImage();
            } else {
              addNewImage();
            }
          });

        // Confirmar eliminación
        document
          .getElementById("confirm-delete")
          .addEventListener("click", deleteImage);

        // Eventos para editar welcome-section (solo front)
        const editWelcomeBtn = document.getElementById("edit-welcome-btn");
        const closeWelcomeModalBtn = document.getElementById(
          "close-welcome-modal"
        );
        const cancelWelcomeBtn = document.getElementById("cancel-welcome");
        const welcomeForm = document.getElementById("welcome-form");

        if (editWelcomeBtn) {
          editWelcomeBtn.addEventListener("click", () => {
            const modal = document.getElementById("welcome-modal");
            const textarea = document.getElementById("welcome-textarea");
            const p = document.getElementById("welcome-text");
            if (textarea && p) textarea.value = p.textContent.trim();
            if (modal) modal.style.display = "flex";
          });
        }

        function closeWelcomeModal() {
          const modal = document.getElementById("welcome-modal");
          if (modal) modal.style.display = "none";
        }

        if (closeWelcomeModalBtn) {
          closeWelcomeModalBtn.addEventListener("click", closeWelcomeModal);
        }
        if (cancelWelcomeBtn) {
          cancelWelcomeBtn.addEventListener("click", closeWelcomeModal);
        }
        if (welcomeForm) {
          welcomeForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const textarea = document.getElementById("welcome-textarea");
            const p = document.getElementById("welcome-text");
            if (textarea && p) {
              const newText = textarea.value.trim();
              if (!newText) {
                alert("La descripción no puede estar vacía.");
                return;
              }
              p.textContent = newText; // solo se guarda en front por ahora
            }
            closeWelcomeModal();
          });
        }
      }

      // Configura visibilidad/valores del campo barbero según rol
      function configureBarberFieldByRole() {
        const group = document.getElementById("barber-field-group");
        const select = document.getElementById("image-barber");
        if (!group || !select) return;

        // Limpiamos opciones para controlarlas nosotros
        select.innerHTML = "";

        if (currentRol === "barbero") {
          // Ocultamos el grupo; el nombre se enviará automático
          group.style.display = "none";

          // Dejamos una opción interna con el nombre actual por si se quiere usar
          const opt = document.createElement("option");
          opt.value = currentUser?.nombre || "Barbero sin nombre";
          opt.textContent = currentUser?.nombre || "Barbero sin nombre";
          select.appendChild(opt);
        } else if (currentRol === "admin") {
          // Mostramos el select con varias opciones
          group.style.display = "block";
          const optIvan = document.createElement("option");
          optIvan.value = "Ivan Barber";
          optIvan.textContent = "Ivan Barber";
          select.appendChild(optIvan);

          const optRef = document.createElement("option");
          optRef.value = "Referencia de internet";
          optRef.textContent = "Referencia de internet";
          select.appendChild(optRef);

          const optOtro = document.createElement("option");
          optOtro.value = "Otro barbero";
          optOtro.textContent = "Otro barbero";
          select.appendChild(optOtro);
        }
      }
      function renderCatalog() {
        const container = document.getElementById("catalog-container");
        const emptyCatalog = document.getElementById("empty-catalog");

        container.innerHTML = "";

        if (!catalogImages || catalogImages.length === 0) {
          if (emptyCatalog) {
            emptyCatalog.style.display = "block";
            container.appendChild(emptyCatalog);
          }
          return;
        }

        if (emptyCatalog) {
          emptyCatalog.style.display = "none";
        }

        catalogImages.forEach((image) => {
          const card = createCatalogCard(image);
          container.appendChild(card);
        });
      }
      function createCatalogCard(image) {
        const card = document.createElement("div");
        card.className = "catalog-card";
        card.setAttribute("data-id", image.id);

        const date = new Date(image.date);
        const formattedDate = isNaN(date)
          ? ""
          : date.toLocaleDateString("es-ES", {
              year: "numeric",
              month: "long",
              day: "numeric",
            });

        card.innerHTML = `
    <div class="catalog-actions">
      <button class="action-btn edit-btn" data-id="${image.id}" title="Editar">
        <i class="fa-solid fa-pen"></i>
      </button>
      <button class="action-btn delete-btn" data-id="${
        image.id
      }" title="Eliminar">
        <i class="fa-solid fa-trash"></i>
      </button> 
    </div>
    <img src="${image.imageUrl}" alt="${image.name}" class="catalog-image">
    <div class="catalog-info">
      <h3 class="catalog-name">${image.name}</h3>
      <p class="catalog-description">${image.description}</p>
      <p class="catalog-barber">Barbero: ${image.nombre_barber}</p>
      <p class="catalog-date">${
        formattedDate ? "Agregado: " + formattedDate : ""
      }</p>
    </div>
  `;

        const editBtn = card.querySelector(".edit-btn");
        const deleteBtn = card.querySelector(".delete-btn");

        editBtn.addEventListener("click", function () {
          openEditModal(image.id);
        });

        deleteBtn.addEventListener("click", function () {
          openDeleteModal(image.id);
        });

        return card;
      }

      function openAddModal() {
        document.getElementById("modal-title").textContent =
          "Agregar Nuevo Trabajo al Catálogo";
        document.getElementById("submit-button").textContent =
          "Guardar en Catálogo";
        document.getElementById("edit-id").value = "";
        document.getElementById("upload-form").reset();
        document.getElementById("image-preview").style.display = "none";
        document.getElementById("image-note").textContent =
          "Selecciona una imagen para subir";
        document.getElementById("image-file").required = true;

        currentEditId = null;
        configureBarberFieldByRole(); // por si acaso

        document.getElementById("upload-modal").style.display = "flex";
      }

      function openEditModal(id) {
        const image = catalogImages.find((img) => img.id === id);
        if (!image) return;

        document.getElementById("modal-title").textContent =
          "Editar Trabajo del Catálogo";
        document.getElementById("submit-button").textContent = "Actualizar";
        document.getElementById("edit-id").value = image.id;
        document.getElementById("image-name").value = image.name;
        document.getElementById("image-description").value = image.description;

        const preview = document.getElementById("image-preview");
        preview.src = image.imageUrl;
        preview.style.display = "block";
        document.getElementById("image-note").textContent =
          "Imagen actual (selecciona una nueva para cambiar)";
        document.getElementById("image-file").required = false;

        currentEditId = id;

        // Si es admin, intentamos marcar el barbero actual en el select
        if (currentRol === "admin") {
          configureBarberFieldByRole();
          const select = document.getElementById("image-barber");
          if (select) {
            Array.from(select.options).forEach((opt) => {
              if (opt.value === image.nombre_barber) {
                opt.selected = true;
              }
            });
          }
        }

        document.getElementById("upload-modal").style.display = "flex";
      }

      function openDeleteModal(id) {
        const image = catalogImages.find((img) => img.id === id);
        if (!image) return;

        document.getElementById("delete-item-name").textContent = image.name;
        itemToDelete = id;
        document.getElementById("delete-modal").style.display = "flex";
      }

      function closeUploadModal() {
        document.getElementById("upload-modal").style.display = "none";
        resetUploadForm();
      }

      function closeDeleteModal() {
        const modal = document.getElementById("delete-modal");
        if (modal) modal.style.display = "none";
        itemToDelete = null;
      }

      // SUBIR NUEVA IMAGEN (a la BD + carpeta uploads)
      async function addNewImage() {
        const name = document.getElementById("image-name").value.trim();
        const description = document
          .getElementById("image-description")
          .value.trim();
        const fileInput = document.getElementById("image-file");

        if (!name || !description) {
          alert("Por favor, completa todos los campos");
          return;
        }

        if (!fileInput.files[0]) {
          alert("Por favor, selecciona una imagen");
          return;
        }

        const formData = new FormData();
        formData.append("nombre", name);
        formData.append("descripcion", description);
        formData.append("imagen", fileInput.files[0]);
        let nombreBarberParaEnviar = "";
        if (currentRol === "barbero") {
          nombreBarberParaEnviar = currentUser?.nombre || "Barbero sin nombre";
        } else if (currentRol === "admin") {
          const select = document.getElementById("image-barber");
          nombreBarberParaEnviar = select
            ? select.value
            : "Referencia de internet";
        }

        formData.append("nombre_barber_ref", nombreBarberParaEnviar);

        const token = getToken();

        try {
          const resp = await fetch(API_CATALOG, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });

          const data = await resp.json();

          if (!resp.ok) {
            alert(data.error || "Error al subir la imagen");
            return;
          }

          await loadCatalogFromServer();
          closeUploadModal();
        } catch (err) {
          console.error("Error al subir imagen", err);
          alert("Error de conexión al subir la imagen");
        }
      }

      // De momento solo actualizamos en front
      async function updateImage() {
        const name = document.getElementById("image-name").value.trim();
        const description = document
          .getElementById("image-description")
          .value.trim();
        const fileInput = document.getElementById("image-file");

        if (!name || !description) {
          alert("Por favor, completa todos los campos");
          return;
        }

        const formData = new FormData();
        formData.append("nombre", name);
        formData.append("descripcion", description);

        // Solo si seleccionó una nueva imagen
        if (fileInput.files[0]) {
          formData.append("imagen", fileInput.files[0]);
        }

        // Determinar nombre_barber según rol
        let nombreBarberParaEnviar = "";
        if (currentRol === "barbero") {
          nombreBarberParaEnviar = currentUser?.nombre || "Barbero sin nombre";
        } else if (currentRol === "admin") {
          const select = document.getElementById("image-barber");
          nombreBarberParaEnviar = select
            ? select.value
            : "Referencia de internet";
        }

        formData.append("nombre_barber_ref", nombreBarberParaEnviar);

        const token = getToken();

        try {
          const resp = await fetch(`${API_CATALOG}/${currentEditId}`, {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });

          const data = await resp.json();

          if (!resp.ok) {
            alert(data.error || "Error al actualizar la imagen");
            return;
          }

          // Recargar catálogo desde servidor
          await loadCatalogFromServer();
          closeUploadModal();
        } catch (err) {
          console.error("Error al actualizar imagen", err);
          alert("Error de conexión al actualizar la imagen");
        }
      }

      async function deleteImage() {
        if (!itemToDelete) {
          console.warn("deleteImage llamado sin itemToDelete");
          return;
        }

        const token = getToken();
        const url = `${API_CATALOG}/${itemToDelete}`;
        console.log("Eliminando trabajo con id:", itemToDelete, "URL:", url);

        try {
          const resp = await fetch(url, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });

          console.log("Respuesta DELETE status:", resp.status);

          let data = {};
          try {
            data = await resp.json();
          } catch (e) {
            console.warn("No se pudo parsear JSON de la respuesta DELETE:", e);
          }

          console.log("Body respuesta DELETE:", data);

          if (!resp.ok) {
            if (resp.status === 404) {
              alert(data.error || "Imagen no encontrada");
            } else if (resp.status === 401) {
              alert("Sesión expirada. Vuelve a iniciar sesión.");
            } else {
              alert(data.error || "Error al eliminar la imagen en el servidor");
            }
            // IMPORTANTE: NO tocamos catalogImages ni renderCatalog aquí
            return;
          }

          // ÉXITO: actualizamos solo el elemento borrado
          catalogImages = catalogImages.filter(
            (img) => img.id !== itemToDelete
          );
          console.log("Nuevo catálogo local tras borrar:", catalogImages);

          renderCatalog();
          closeDeleteModal();

          alert("Trabajo eliminado con éxito");
        } catch (err) {
          console.error("Error de conexión al eliminar imagen:", err);
          // Aquí NO tocamos catalogImages ni renderCatalog
          alert("Error de conexión al eliminar el trabajo");
        } finally {
          itemToDelete = null;
        }
      }

      function resetUploadForm() {
        document.getElementById("upload-form").reset();
        document.getElementById("image-preview").style.display = "none";
        document.getElementById("image-note").textContent =
          "Selecciona una imagen para subir";
        document.getElementById("image-file").required = true;
        currentEditId = null;
      }
    </script>
  </body>
</html>
