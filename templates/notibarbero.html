<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Barber Studio - Notificaciones</title>
    <link rel="stylesheet" href="/static/notibarbero.css" />
    <link rel="stylesheet" href="/static/alerts.css" />
  </head>
  <body>
    <header class="header">
      <div class="block">
        <img
          class="imagen-de-barberia"
          src="/images/barber.jpg"
          alt="Logo Barber"
        />
      </div>
      <nav class="navigation-pill-list" aria-label="Navegación principal">
        <a href="/perfil" class="navigation-pill">
          <span class="title">Mi Perfil</span>
        </a>
        <a href="/homebarber" class="navigation-pill">
          <span class="title">Inicio</span>
        </a>
        <a href="/barber_agenda" class="navigation-pill">
          <span class="">Agenda</span>
        </a>
        <a href="/notibarbero" class="navigation-pill">
          <span class="title">Notificaciones</span>
        </a>
        <a href="/clientes" class="navigation-pill">
          <span class="title">Clientes</span>
        </a>
        <a href="/" class="navigation-pill">
          <span class="title">Cerrar Sesión</span>
        </a>
      </nav>
    </header>

    <main class="main-content">
      <div class="notifications-header">
        <h1 class="notifications-title">Notificaciones</h1>
        <div class="notifications-actions">
          <button class="mark-all-read" id="mark-all-read">
            Marcar todas como leídas
          </button>
        </div>
      </div>

      <div class="notifications-container">
        <div class="notification-tabs">
          <div class="notification-tab active" data-tab="all">Todas</div>
          <div class="notification-tab" data-tab="unread">No leídas</div>
          <div class="notification-tab" data-tab="appointments">
            Nuevas Citas
          </div>
          <div class="notification-tab" data-tab="changes">Cambios</div>
        </div>

        <div class="notification-list" id="notification-list">
          <div id="pagination" class="pagination"></div>
        </div>
      </div>
    </main>

    <footer class="footer">
      <div class="footer-logo">
        <img
          class="imagen-de-barberia"
          src="/images/barber.jpg"
          alt="Logo Barber "
        />
      </div>
      <nav class="text-link-list" aria-labelledby="footer-contact">
        <div class="text-strong-wrapper">
          <h2 id="footer-contact" class="text-strong">
            <span class="text-strong-2">contacto</span>
          </h2>
        </div>
        <ul class="footer-list">
          <li class="text-link-list-item">
            <a href="tel:9837324637" class="list-item">9837324637</a>
          </li>
          <li class="text-link-list-item">
            <a href="mailto:barberpi@utttn.mx" class="list-item-2"
              >barberpi@utttn.mx</a
            >
          </li>
        </ul>
      </nav>
      <nav class="text-link-list" aria-labelledby="footer-location">
        <div class="text-strong-wrapper">
          <h2 id="footer-location" class="text-strong">
            <span class="text-strong-2">ubicación</span>
          </h2>
        </div>
        <ul class="footer-list">
          <li class="text-link-list-item">
            <a
              href="https://maps.app.goo.gl/ZD5gur5vPiwKMVCW9?g_st=iw"
              target="_blank"
              rel="noopener noreferrer"
              class="list-item-7"
              >google.maps/micasa</a
            >
          </li>
        </ul>
      </nav>
      <nav class="text-link-list" aria-labelledby="footer-creator">
        <div class="text-strong-wrapper">
          <h2 id="footer-creator" class="text-strong">
            <span class="">creado por:</span>
          </h2>
        </div>
        <ul class="footer-list">
          <li class="text-link-list-item">
            <span class="list-item-11">Axel Rivera</span>
          </li>
          <li class="text-link-list-item">
            <span class="list-item-12">contactos:</span>
          </li>
          <li class="text-link-list-item">
            <a href="mailto:axel.delgado@uttn.mx" class="list-item-13"
              >axel.delgado@uttn.mx</a
            >
          </li>
          <li class="text-link-list-item">
            <a href="tel:8994287620" class="list-item">8994287620</a>
          </li>
        </ul>
      </nav>
    </footer>
    <script>
      const toastContainer = document.getElementById("app-toast-container");
      const modalContainer = document.getElementById("app-modal-container");

      window.showToast = function (text = "", type = "info", timeout = 3000) {
        return new Promise((resolve) => {
          if (!toastContainer) return resolve();
          const wrap = document.createElement("div");
          wrap.className = "app-toast " + type;
          wrap.innerHTML = `<div class="msg">${text}</div><button class="close-btn" aria-label="Cerrar">&times;</button>`;
          const closeBtn = wrap.querySelector(".close-btn");
          let removed = false;
          const cleanup = () => {
            if (removed) return;
            removed = true;
            try {
              toastContainer.removeChild(wrap);
            } catch (e) {}
            resolve();
          };
          closeBtn.addEventListener("click", cleanup);
          toastContainer.appendChild(wrap);
          setTimeout(cleanup, timeout);
        });
      };

      window.showConfirm = function (title = "Confirmar", message = "") {
        return new Promise((resolve) => {
          if (!modalContainer) {
            console.warn("Modal container missing");
            return resolve(false);
          }
          const backdrop = document.createElement("div");
          backdrop.className = "app-modal-backdrop";
          backdrop.innerHTML = `
              <div class="app-modal" role="dialog" aria-modal="true" tabindex="0">
                <h3>${title}</h3>
                <p>${message}</p>
                <div class="row">
                  <button class="app-btn ghost" id="app-cancel-btn">Cancelar</button>
                  <button class="app-btn primary" id="app-ok-btn">Aceptar</button>
                </div>
              </div>
            `;
          modalContainer.appendChild(backdrop);
          const prevOverflow = document.body.style.overflow;
          document.body.style.overflow = "hidden";

          const ok = backdrop.querySelector("#app-ok-btn");
          const cancel = backdrop.querySelector("#app-cancel-btn");
          const modalEl = backdrop.querySelector(".app-modal");

          const cleanup = (value) => {
            try {
              if (modalContainer.contains(backdrop))
                modalContainer.removeChild(backdrop);
            } catch (e) {}
            document.body.style.overflow = prevOverflow || "";
            resolve(Boolean(value));
          };

          cancel.addEventListener("click", () => cleanup(false));
          ok.addEventListener("click", () => cleanup(true));
          backdrop.addEventListener("click", (ev) => {
            if (ev.target === backdrop) cleanup(false);
          });

          setTimeout(() => {
            modalEl.focus();
            cancel.focus();
          }, 10);
        });
      };

      const API_BASE =
        window.location.hostname.includes("localhost") ||
        window.location.hostname === "127.0.0.1"
          ? "http://localhost:4000/api"
          : `${window.location.origin}/api`;
      const API_NOTIFICACIONES = `${API_BASE}/api/notificaciones`;

      let notifications = [];
      let currentFilter = "all";

      let currentPage = 1;
      const PAGE_SIZE = 10;
      let totalItems = 0;
      let totalPages = 1;

      function getToken() {
        return localStorage.getItem("token");
      }
      function getReadSet() {
        try {
          const raw = localStorage.getItem("noti_barbero_leidas") || "[]";
          return new Set(JSON.parse(raw));
        } catch {
          return new Set();
        }
      }
      function saveReadSet(set) {
        localStorage.setItem(
          "noti_barbero_leidas",
          JSON.stringify(Array.from(set))
        );
      }

      document.addEventListener("DOMContentLoaded", async () => {
        await loadNotifications(currentPage);
        setupEventListeners();
      });

      async function loadNotifications(page = 1) {
        const token = getToken();
        if (!token) {
          await showToast(
            "No estás autenticado. Redirigiendo al login...",
            "error",
            1600
          );
          setTimeout(() => (window.location.href = "/"), 1400);
          return;
        }

        try {
          const resp = await fetch(
            `${API_NOTIFICACIONES}/barbero?page=${page}&pageSize=${PAGE_SIZE}`,
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          if (!resp.ok) {
            const text = await resp.text();
            console.error("Error al cargar notificaciones:", resp.status, text);
            await showToast("Error al cargar notificaciones", "error", 2000);
            return;
          }

          const json = await resp.json();
          totalItems = json.total || 0;
          currentPage = json.page || page;
          const pageSize = json.pageSize || PAGE_SIZE;
          totalPages = Math.max(1, Math.ceil(totalItems / pageSize));

          const leidasSet = getReadSet();

          notifications = (json.notifications || []).map((n) => ({
            id:
              n.id_notificacion ||
              n.id_cita ||
              Math.random().toString(36).slice(2),
            id_cita: n.id_cita,
            type: mapTipo(n.tipo),
            title: n.titulo || "",
            message: n.mensaje || "",
            client: n.nombre_cliente,
            service: n.nombre_servicio,
            date: n.fecha_cita,
            time: n.hora_inicio,
            timestamp: n.timestamp || new Date().toISOString(),
            read: leidasSet.has(n.id_notificacion || n.id_cita),
            actions: getActionsForType(n.tipo),
          }));

          renderNotifications();
          renderPagination();
        } catch (err) {
          console.error("Error conexión notificaciones:", err);
          await showToast(
            "Error de conexión al cargar notificaciones",
            "error",
            2000
          );
        }
      }

      function renderPagination() {
        const container = document.getElementById("pagination");
        if (!container) return;
        container.innerHTML = "";

        if (totalPages <= 1) return;

        const createBtn = (text, disabled, clickHandler) => {
          const btn = document.createElement("button");
          btn.className = "page-btn";
          btn.disabled = disabled;
          btn.textContent = text;
          if (!disabled) btn.addEventListener("click", clickHandler);
          return btn;
        };

        container.appendChild(
          createBtn("« Anterior", currentPage === 1, async () => {
            if (currentPage > 1) {
              await loadNotifications(currentPage - 1);
            }
          })
        );

        const maxButtons = 7;
        let start = Math.max(1, currentPage - 3);
        let end = Math.min(totalPages, start + maxButtons - 1);
        if (end - start < maxButtons - 1)
          start = Math.max(1, end - maxButtons + 1);

        if (start > 1) {
          container.appendChild(
            createBtn("1", false, async () => await loadNotifications(1))
          );
          if (start > 2) {
            const dots = document.createElement("span");
            dots.textContent = "...";
            dots.className = "page-dots";
            container.appendChild(dots);
          }
        }

        for (let p = start; p <= end; p++) {
          const btn = createBtn(String(p), p === currentPage, async () => {
            if (p !== currentPage) await loadNotifications(p);
          });
          if (p === currentPage) btn.classList.add("active-page");
          container.appendChild(btn);
        }

        if (end < totalPages) {
          if (end < totalPages - 1) {
            const dots = document.createElement("span");
            dots.textContent = "...";
            dots.className = "page-dots";
            container.appendChild(dots);
          }
          container.appendChild(
            createBtn(
              String(totalPages),
              false,
              async () => await loadNotifications(totalPages)
            )
          );
        }

        container.appendChild(
          createBtn("Siguiente »", currentPage === totalPages, async () => {
            if (currentPage < totalPages) {
              await loadNotifications(currentPage + 1);
            }
          })
        );
      }

      function mapTipo(tipo) {
        const map = {
          nueva: "appointment",
          cancelada: "cancellation",
          confirmada: "appointment",
          completada: "appointment",
        };
        return map[tipo] || "appointment";
      }
      function getActionsForType(tipo) {
        if (tipo === "nueva") return ["view", "confirm"];
        if (tipo === "cancelada") return ["reschedule"];
        if (tipo === "confirmada" || tipo === "completada") return ["view"];
        return ["view"];
      }

      function setupEventListeners() {
        document.querySelectorAll(".notification-tab").forEach((tab) => {
          tab.addEventListener("click", function () {
            document
              .querySelectorAll(".notification-tab")
              .forEach((t) => t.classList.remove("active"));
            this.classList.add("active");
            currentFilter = this.getAttribute("data-tab");
            renderNotifications();
          });
        });

        const markAllBtn = document.getElementById("mark-all-read");
        if (markAllBtn) {
          markAllBtn.addEventListener("click", async () => {
            const set = getReadSet();
            notifications.forEach((n) => set.add(n.id));
            saveReadSet(set);
            notifications.forEach((n) => (n.read = true));
            renderNotifications();

            try {
              const token = getToken();
              const ids = notifications.map((n) => n.id);
              await fetch(`${API_NOTIFICACIONES}/marcar-leidas`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ ids }),
              });
            } catch (err) {
              console.warn(
                "No se pudo notificar al backend por marcar todas:",
                err
              );
            }
            await showToast("Todas marcadas como leídas", "success", 1200);
          });
        }
      }

      function renderNotifications() {
        const container = document.getElementById("notification-list");
        container.innerHTML = "";

        let filtered = notifications;
        if (currentFilter === "unread")
          filtered = notifications.filter((n) => !n.read);
        else if (currentFilter === "appointments")
          filtered = notifications.filter((n) => n.type === "appointment");
        else if (currentFilter === "changes")
          filtered = notifications.filter((n) => n.type === "cancellation");

        filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        if (!filtered.length) {
          const empty = document.createElement("div");
          empty.className = "empty-notifications";
          empty.textContent = "No hay notificaciones para mostrar";
          container.appendChild(empty);
          return;
        }

        filtered.forEach((n) =>
          container.appendChild(createNotificationElement(n))
        );
      }

      function createNotificationElement(notification) {
        const item = document.createElement("div");
        item.className = `notification-item ${
          notification.read ? "" : "unread"
        }`;
        item.dataset.id = notification.id;

        const iconText =
          notification.type === "appointment"
            ? "/images/calendario"
            : "/images/cancelado";
        const timeAgo = getTimeAgo(notification.timestamp);

        let buttonsHtml = "";
        if (notification.actions.includes("view"))
          buttonsHtml += `<button class="btn btn-primary" data-action="view">Ver Detalles</button>`;
        if (notification.actions.includes("confirm"))
          buttonsHtml += `<button class="btn btn-success" data-action="confirm">Confirmar</button>`;
        if (notification.actions.includes("reschedule"))
          buttonsHtml += `<button class="btn btn-warning" data-action="reschedule">Reagendar</button>`;
        if (!notification.read)
          buttonsHtml += `<button class="btn btn-secondary" data-action="mark-read">Marcar como leída</button>`;

        item.innerHTML = `
      <div class="notification-icon">${iconText}</div>
      <div class="notification-content">
        <div class="notification-message">
          <strong>${notification.title}</strong><br>
          ${notification.message || ""}
          ${
            notification.client
              ? `<br><span class="notification-client">Cliente: ${notification.client}</span>`
              : ""
          }
          ${
            notification.service
              ? `<span class="notification-service"> - ${notification.service}</span>`
              : ""
          }
          ${
            notification.date
              ? `<br><span class="notification-date">Fecha: ${formatDate(
                  notification.date
                )} a las ${notification.time}</span>`
              : ""
          }
        </div>
        <div class="notification-meta">
          <span class="notification-time">${timeAgo}</span>
          <div class="notification-actions">${buttonsHtml}</div>
        </div>
      </div>
    `;

        item.querySelectorAll("button").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const action = btn.dataset.action;
            await handleNotificationAction(notification, action);
          });
        });

        return item;
      }

      async function handleNotificationAction(notification, action) {
        const token = getToken();
        switch (action) {
          case "view":
            window.location.href = `/barber_agenda?cita=${
              notification.id_cita || notification.id
            }`;
            break;
          case "confirm":
            {
              const ok = await showConfirm(
                "Confirmar cita",
                `¿Confirmar la cita con ${notification.client || ""} para ${
                  notification.service || ""
                }?`
              );
              if (!ok) return;
              try {
                await fetch(
                  `${API_BASE}/citas/${notification.id_cita}/estado`,
                  {
                    method: "PATCH",
                    headers: {
                      "Content-Type": "application/json",
                      Authorization: `Bearer ${token}`,
                    },
                    body: JSON.stringify({ estado: "confirmada" }),
                  }
                );
                await showToast("Cita confirmada", "success", 1400);
                await markAsRead(notification.id);
              } catch (err) {
                console.error("Error confirmando cita:", err);
                await showToast("Error al confirmar cita", "error", 1800);
              }
            }
            break;
          case "reschedule":
            window.location.href = `/barber_agenda?reagendar=${
              notification.id_cita || notification.id
            }`;
            break;
          case "mark-read":
            await markAsRead(notification.id);
            break;
        }
      }

      async function markAsRead(id) {
        const set = getReadSet();
        set.add(id);
        saveReadSet(set);
        const notif = notifications.find((n) => n.id === id);
        if (notif) notif.read = true;
        renderNotifications();

        try {
          const token = getToken();
          await fetch(`${API_NOTIFICACIONES}/marcar-leida`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ id_notificacion: id }),
          });
        } catch (err) {
          console.warn("Error marcando leída en backend:", err);
        }
      }

      function formatDate(dateString) {
        if (!dateString) return "";
        const date = new Date(dateString);
        return date.toLocaleDateString("es-ES", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });
      }

      function getTimeAgo(timestamp) {
        const now = new Date();
        const t = new Date(timestamp);
        const diffMs = now - t;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        if (diffMins < 1) return "Hace un momento";
        if (diffMins < 60)
          return `Hace ${diffMins} minuto${diffMins > 1 ? "s" : ""}`;
        if (diffHours < 24)
          return `Hace ${diffHours} hora${diffHours > 1 ? "s" : ""}`;
        if (diffDays < 7)
          return `Hace ${diffDays} día${diffDays > 1 ? "s" : ""}`;
        return t.toLocaleDateString("es-ES");
      }
    </script>
  </body>
</html>
