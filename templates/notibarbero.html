<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Barber Studio - Notificaciones</title>
    <link rel="stylesheet" href="/static/notibarbero.css" />
    <link rel="stylesheet" href="/static/alerts.css" />
  </head>
  <body>
    <header class="header">
      <div class="block">
        <img
          class="imagen-de-barberia"
          src="/images/barber.jpg"
          alt="Logo Barber Studio"
        />
      </div>
      <nav class="navigation-pill-list" aria-label="Navegaci√≥n principal">
        <a href="/perfil" class="navigation-pill">
          <span class="title">Mi Perfil</span>
        </a>
        <a href="/homebarber" class="navigation-pill">
          <span class="title">Inicio</span>
        </a>
        <a href="/barber_agenda" class="navigation-pill">
          <span class="">Agenda</span>
        </a>
        <a href="/notibarbero" class="navigation-pill">
          <span class="title">Notificaciones</span>
        </a>
        <a href="/" class="navigation-pill">
          <span class="title">Cerrar Sesi√≥n</span>
        </a>
      </nav>
    </header>

    <main class="main-content">
      <div class="notifications-header">
        <h1 class="notifications-title">Notificaciones</h1>
        <div class="notifications-actions">
          <button class="mark-all-read" id="mark-all-read">
            Marcar todas como le√≠das
          </button>
        </div>
      </div>

      <div class="notifications-container">
        <div class="notification-tabs">
          <div class="notification-tab active" data-tab="all">Todas</div>
          <div class="notification-tab" data-tab="unread">No le√≠das</div>
          <div class="notification-tab" data-tab="appointments">
            Nuevas Citas
          </div>
          <div class="notification-tab" data-tab="changes">Cambios</div>
        </div>

        <div class="notification-list" id="notification-list">
          <!-- Las notificaciones se generar√°n con JavaScript -->
        </div>
      </div>
    </main>

    <footer class="footer">
      <div class="footer-logo">
        <img
          class="imagen-de-barberia"
          src="/images/barber.jpg"
          alt="Barber Studio Logo"
        />
      </div>
      <nav class="text-link-list" aria-labelledby="footer-contact">
        <div class="text-strong-wrapper">
          <h2 id="footer-contact" class="text-strong">
            <span class="text-strong-2">contacto</span>
          </h2>
        </div>
        <ul class="footer-list">
          <li class="text-link-list-item">
            <a href="tel:9837324637" class="list-item">9837324637</a>
          </li>
          <li class="text-link-list-item">
            <a href="mailto:barberpi@utttn.mx" class="list-item-2"
              >barberpi@utttn.mx</a
            >
          </li>
        </ul>
      </nav>
      <nav class="text-link-list" aria-labelledby="footer-location">
        <div class="text-strong-wrapper">
          <h2 id="footer-location" class="text-strong">
            <span class="text-strong-2">ubicaci√≥n</span>
          </h2>
        </div>
        <ul class="footer-list">
          <li class="text-link-list-item">
            <a
              href="https://maps.app.goo.gl/ZD5gur5vPiwKMVCW9?g_st=iw"
              target="_blank"
              rel="noopener noreferrer"
              class="list-item-7"
              >google.maps/micasa</a
            >
          </li>
        </ul>
      </nav>
      <nav class="text-link-list" aria-labelledby="footer-creator">
        <div class="text-strong-wrapper">
          <h2 id="footer-creator" class="text-strong">
            <span class="">creado por:</span>
          </h2>
        </div>
        <ul class="footer-list">
          <li class="text-link-list-item">
            <span class="list-item-11">Axel Rivera</span>
          </li>
          <li class="text-link-list-item">
            <span class="list-item-12">contactos:</span>
          </li>
          <li class="text-link-list-item">
            <a href="mailto:axel.delgado@uttn.mx" class="list-item-13"
              >axel.delgado@uttn.mx</a
            >
          </li>
          <li class="text-link-list-item">
            <a href="tel:8994287620" class="list-item">8994287620</a>
          </li>
        </ul>
      </nav>
    </footer>
    <div id="app-notify-root">
      <div id="app-toast-container" class="toast-container"></div>
      <div id="app-modal-container"></div>
    </div>

    <script>
      (function notifyHelpers() {
        const toastContainer = document.getElementById("app-toast-container");
        const modalContainer = document.getElementById("app-modal-container");

        window.showToast = function (text = "", type = "info", timeout = 3500) {
          return new Promise((resolve) => {
            if (!toastContainer) {
              console.warn("Toast container missing:", text);
              return resolve();
            }
            const wrap = document.createElement("div");
            wrap.className = `app-toast ${type}`;
            wrap.innerHTML = `<div class="msg">${text}</div><button class="close-btn" aria-label="close">&times;</button>`;
            const closeBtn = wrap.querySelector(".close-btn");
            let removed = false;
            const cleanup = () => {
              if (removed) return;
              removed = true;
              wrap.style.opacity = "0";
              setTimeout(() => {
                try {
                  toastContainer.removeChild(wrap);
                } catch (e) {}
                resolve();
              }, 180);
            };
            closeBtn.addEventListener("click", cleanup);
            toastContainer.appendChild(wrap);
            setTimeout(cleanup, timeout || 3500);
          });
        };

        window.showConfirm = function (title = "Confirmar", message = "") {
          return new Promise((resolve) => {
            if (!modalContainer) {
              console.warn("Modal container missing:", title, message);
              return resolve(false);
            }
            const backdrop = document.createElement("div");
            backdrop.className = "app-modal-backdrop";
            backdrop.innerHTML = `
              <div class="app-modal" role="dialog" aria-modal="true">
                <h3>${title}</h3>
                <p>${message}</p>
                <div class="row">
                  <button class="app-btn ghost" id="app-cancel-btn">Cancelar</button>
                  <button class="app-btn primary" id="app-ok-btn">Aceptar</button>
                </div>
              </div>
            `;
            modalContainer.appendChild(backdrop);
            const ok = backdrop.querySelector("#app-ok-btn");
            const cancel = backdrop.querySelector("#app-cancel-btn");
            const cleanup = (value) => {
              try {
                modalContainer.removeChild(backdrop);
              } catch (e) {}
              resolve(Boolean(value));
            };
            cancel.addEventListener("click", () => cleanup(false));
            ok.addEventListener("click", () => cleanup(true));
            backdrop.addEventListener("click", (ev) => {
              if (ev.target === backdrop) cleanup(false);
            });
          });
        };
      })();
      const API_BASE =
        window.location.hostname.includes("localhost") ||
        window.location.hostname === "127.0.0.1"
          ? "http://localhost:4000"
          : `${window.location.origin}/api`;
      const API_NOTIFICACIONES = `${API_BASE}/notificaciones`;

      let notifications = [];
      let currentFilter = "all";

      function getToken() {
        return localStorage.getItem("token");
      }

      // "Le√≠das" solo en el navegador del barbero (localStorage)
      function getReadSet() {
        try {
          const raw = localStorage.getItem("noti_barbero_leidas") || "[]";
          return new Set(JSON.parse(raw));
        } catch {
          return new Set();
        }
      }

      function saveReadSet(set) {
        localStorage.setItem(
          "noti_barbero_leidas",
          JSON.stringify(Array.from(set))
        );
      }

      document.addEventListener("DOMContentLoaded", async () => {
        await loadNotifications();
        setupEventListeners();
      });

      async function loadNotifications() {
        const token = getToken();
        if (!token) {
          await showToast("No est√°s autenticado. Redirigiendo al login.","error",3000);
          window.location.href = "/";
          return;
        }

        try {
          const resp = await fetch(`${API_NOTIFICACIONES}/barbero`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!resp.ok) {
            const text = await resp.text();
            console.error("Error al cargar notificaciones:", resp.status, text);
            await showToast("Error al cargar notificaciones","error",4000);
            return;
          }

          const data = await resp.json();
          const leidasSet = getReadSet();

          notifications = data.map((n) => ({
            id: n.id_cita,
            id_cita: n.id_cita,
            type: mapTipo(n.tipo),
            title: n.titulo,
            message: n.mensaje,
            client: n.nombre_cliente,
            service: n.nombre_servicio,
            date: n.fecha_cita,
            time: n.hora_inicio,
            timestamp: new Date(n.timestamp),
            read: leidasSet.has(n.id_cita),
            actions: getActionsForType(n.tipo),
          }));

          renderNotifications();
        } catch (err) {
          console.error("Error conexi√≥n notificaciones:", err);
          await showToast("Error de conexi√≥n al cargar notificaciones","error",4000);
        }
      }

      function mapTipo(tipo) {
        const map = {
          nueva: "appointment",
          cancelada: "cancellation",
          confirmada: "appointment",
          completada: "appointment",
        };
        return map[tipo] || "appointment";
      }

      function getActionsForType(tipo) {
        if (tipo === "nueva") {
          return ["view", "confirm"];
        } else if (tipo === "cancelada") {
          return ["reschedule"];
        } else if (tipo === "confirmada" || tipo === "completada") {
          return ["view"];
        }
        return ["view"];
      }

      function setupEventListeners() {
        document.querySelectorAll(".notification-tab").forEach((tab) => {
          tab.addEventListener("click", function () {
            document
              .querySelectorAll(".notification-tab")
              .forEach((t) => t.classList.remove("active"));
            this.classList.add("active");
            currentFilter = this.getAttribute("data-tab");
            renderNotifications();
          });
        });

        document
          .getElementById("mark-all-read")
          .addEventListener("click", markAllAsRead);
      }

      function renderNotifications() {
        const container = document.getElementById("notification-list");
        container.innerHTML = "";

        let filtered = notifications;

        if (currentFilter === "unread") {
          filtered = notifications.filter((n) => !n.read);
        } else if (currentFilter === "appointments") {
          filtered = notifications.filter((n) => n.type === "appointment");
        } else if (currentFilter === "changes") {
          filtered = notifications.filter((n) => n.type === "cancellation");
        }

        filtered.sort((a, b) => b.timestamp - a.timestamp);

        if (!filtered.length) {
          const empty = document.createElement("div");
          empty.className = "empty-notifications";
          empty.textContent = "No hay notificaciones para mostrar";
          container.appendChild(empty);
          return;
        }

        filtered.forEach((n) =>
          container.appendChild(createNotificationElement(n))
        );
      }

      function createNotificationElement(notification) {
        const item = document.createElement("div");
        item.className = `notification-item ${
          notification.read ? "" : "unread"
        }`;
        item.dataset.id = notification.id;

        let iconClass = "";
        let iconText = "";

        switch (notification.type) {
          case "appointment":
            iconClass = "appointment";
            iconText = "üìÖ";
            break;
          case "cancellation":
            iconClass = "cancellation";
            iconText = "‚ùå";
            break;
        }

        const timeAgo = getTimeAgo(notification.timestamp);

        let buttonsHtml = "";
        if (notification.actions.includes("view")) {
          buttonsHtml += `<button class="btn btn-primary" data-action="view">Ver Detalles</button>`;
        }
        if (notification.actions.includes("confirm")) {
          buttonsHtml += `<button class="btn btn-success" data-action="confirm">Confirmar</button>`;
        }
        if (notification.actions.includes("reschedule")) {
          buttonsHtml += `<button class="btn btn-warning" data-action="reschedule">Reagendar</button>`;
        }
        if (!notification.read) {
          buttonsHtml += `<button class="btn btn-secondary" data-action="mark-read">Marcar como le√≠da</button>`;
        }

        item.innerHTML = `
      <div class="notification-icon ${iconClass}">${iconText}</div>
      <div class="notification-content">
        <div class="notification-message">
          <strong>${notification.title}</strong><br>
          ${notification.message}
          ${
            notification.client
              ? `<br><span class="notification-client">Cliente: ${notification.client}</span>`
              : ""
          }
          ${
            notification.service
              ? `<span class="notification-service"> - ${notification.service}</span>`
              : ""
          }
          ${
            notification.date
              ? `<br><span class="notification-date">Fecha: ${formatDate(
                  notification.date
                )} a las ${notification.time}</span>`
              : ""
          }
        </div>
        <div class="notification-meta">
          <span class="notification-time">${timeAgo}</span>
          <div class="notification-actions">
            ${buttonsHtml}
          </div>
        </div>
      </div>
    `;

        item.querySelectorAll("button").forEach((btn) => {
          btn.addEventListener("click", () => {
            const action = btn.dataset.action;
            handleNotificationAction(notification.id, action, notification);
          });
        });

        return item;
      }

      function handleNotificationAction(id, action, notification) {
        switch (action) {
          case "view":
            window.location.href = `/barber_agenda?cita=${notification.id_cita}`;
            break;
          case "confirm":
            if (
              confirm(
                `¬øConfirmar la cita con ${notification.client} para ${notification.service}?`
              )
            ) {
              showToast("Cita confirmada", "success",4000);
              markAsRead(id);
            }
            break;
          case "reschedule":
            window.location.href = `/barber_agenda?reagendar=${notification.id_cita}`;
            break;
          case "mark-read":
            markAsRead(id);
            break;
        }
      }

      function markAsRead(id) {
        const set = getReadSet();
        set.add(id);
        saveReadSet(set);

        const notif = notifications.find((n) => n.id === id);
        if (notif) notif.read = true;

        renderNotifications();
      }

      function markAllAsRead() {
        const set = getReadSet();
        notifications.forEach((n) => set.add(n.id));
        saveReadSet(set);
        notifications.forEach((n) => (n.read = true));
        renderNotifications();
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("es-ES", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });
      }

      function getTimeAgo(timestamp) {
        const now = new Date();
        const diffMs = now - new Date(timestamp);
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return "Hace un momento";
        if (diffMins < 60)
          return `Hace ${diffMins} minuto${diffMins > 1 ? "s" : ""}`;
        if (diffHours < 24)
          return `Hace ${diffHours} hora${diffHours > 1 ? "s" : ""}`;
        if (diffDays < 7)
          return `Hace ${diffDays} d√≠a${diffDays > 1 ? "s" : ""}`;
        return new Date(timestamp).toLocaleDateString("es-ES");
      }
    </script>
  </body>
</html>
