<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Barber Studio - Notificaciones</title>
    <link rel="stylesheet" href="/static/notibarbero.css" />
  </head>
  <body>
    <header class="header">
      <div class="block">
        <img class="imagen-de-barberia" src="/images/barber.jpg" alt="Logo Barber Studio" />
      </div>
      <nav class="navigation-pill-list" aria-label="Navegaci√≥n principal">
        <a href="/templates/perfil.html" class="navigation-pill"><span class="title">Mi Perfil</span></a>
        <a href="/templates/homebarber.html" class="navigation-pill"><span class="title">Inicio</span></a>
        <a href="/templates/barber_agenda.html" class="navigation-pill"><span class="">Agenda</span></a>
        <a href="/templates/notibarbero.html" class="navigation-pill"><span class="title">Notificaciones</span></a>
        <a href="/templates/login.html" class="navigation-pill"><span class="title">Cerrar Sesi√≥n</span></a>
      </nav>
    </header>

    <main class="main-content">
      <div class="notifications-header">
        <h1 class="notifications-title">Notificaciones</h1>
        <div class="notifications-actions">
          <button class="mark-all-read" id="mark-all-read">Marcar todas como le√≠das</button>
        </div>
      </div>

      <div class="notifications-container">
        <div class="notification-tabs">
          <div class="notification-tab active" data-tab="all">Todas</div>
          <div class="notification-tab" data-tab="unread">No le√≠das</div>
          <div class="notification-tab" data-tab="appointments">Nuevas Citas</div>
          <div class="notification-tab" data-tab="changes">Cambios</div>
        </div>

        <div class="notification-list" id="notification-list"></div>
      </div>
    </main>

    <footer class="footer"> ... <!-- tu footer --> </footer>

    <!-- Contenedor para toasts y modales -->
    <div id="app-notify-root">
      <div id="app-toast-container" class="toast-container"></div>
      <div id="app-modal-container"></div>
    </div>

    <script>
      /* ---------- UI: showToast / showConfirm (reemplaza alert/confirm) ---------- */
      const toastContainer = document.getElementById('app-toast-container');
      const modalContainer = document.getElementById('app-modal-container');

      window.showToast = function (text = '', type = 'info', timeout = 3000) {
        return new Promise((resolve) => {
          if (!toastContainer) return resolve();
          const wrap = document.createElement('div');
          wrap.className = 'app-toast ' + type;
          wrap.innerHTML = `<div class="msg">${text}</div><button class="close-btn" aria-label="Cerrar">&times;</button>`;
          const closeBtn = wrap.querySelector('.close-btn');
          let removed = false;
          const cleanup = () => {
            if (removed) return;
            removed = true;
            try { toastContainer.removeChild(wrap); } catch(e){}
            resolve();
          };
          closeBtn.addEventListener('click', cleanup);
          toastContainer.appendChild(wrap);
          setTimeout(cleanup, timeout);
        });
      };

      window.showConfirm = function(title = 'Confirmar', message = '') {
        return new Promise((resolve) => {
          if (!modalContainer) { console.warn('Modal container missing'); return resolve(false); }
          const backdrop = document.createElement('div');
          backdrop.className = 'app-modal-backdrop';
          backdrop.innerHTML = `
            <div class="app-modal" role="dialog" aria-modal="true" tabindex="0">
              <h3>${title}</h3>
              <p>${message}</p>
              <div class="row">
                <button class="app-btn ghost" id="app-cancel-btn">Cancelar</button>
                <button class="app-btn primary" id="app-ok-btn">Aceptar</button>
              </div>
            </div>
          `;
          modalContainer.appendChild(backdrop);
          const prevOverflow = document.body.style.overflow;
          document.body.style.overflow = 'hidden';

          const ok = backdrop.querySelector('#app-ok-btn');
          const cancel = backdrop.querySelector('#app-cancel-btn');
          const modalEl = backdrop.querySelector('.app-modal');

          const cleanup = (value) => {
            try { if (modalContainer.contains(backdrop)) modalContainer.removeChild(backdrop); } catch(e){}
            document.body.style.overflow = prevOverflow || '';
            resolve(Boolean(value));
          };

          cancel.addEventListener('click', () => cleanup(false));
          ok.addEventListener('click', () => cleanup(true));
          backdrop.addEventListener('click', (ev) => { if (ev.target === backdrop) cleanup(false); });

          setTimeout(() => { modalEl.focus(); cancel.focus(); }, 10);
        });
      };

      /* ---------- Notificaciones: frontend logic (sin alert/confirm nativos) ---------- */

      // API dynamic: local vs deployed
      const API_BASE = (window.location.hostname.includes('localhost') || window.location.hostname === '127.0.0.1')
        ? 'http://localhost:4000/api'
        : `${window.location.origin}/api`;

      const API_NOTIFICACIONES = `${API_BASE}/notificaciones`;

      let notifications = [];
      let currentFilter = "all";

      function getToken() { return localStorage.getItem('token'); }

      function getReadSet() {
        try {
          const raw = localStorage.getItem("noti_barbero_leidas") || "[]";
          return new Set(JSON.parse(raw));
        } catch { return new Set(); }
      }
      function saveReadSet(set) { localStorage.setItem("noti_barbero_leidas", JSON.stringify(Array.from(set))); }

      document.addEventListener("DOMContentLoaded", async () => {
        await loadNotifications();
        setupEventListeners();
      });

      async function loadNotifications() {
        const token = getToken();
        if (!token) {
          await showToast("No est√°s autenticado. Redirigiendo al login...", "error", 2000);
          setTimeout(() => window.location.href = "/templates/login.html", 1400);
          return;
        }

        try {
          // Si eres admin y quieres ver otro barbero, frontend puede a√±adir ?id_barbero=...
          const resp = await fetch(`${API_NOTIFICACIONES}/barbero`, { headers: { Authorization: `Bearer ${token}` } });
          if (!resp.ok) {
            const text = await resp.text();
            console.error("Error al cargar notificaciones:", resp.status, text);
            await showToast("Error al cargar notificaciones", "error", 2200);
            return;
          }

          const data = await resp.json();
          const leidasSet = getReadSet();

          notifications = data.map((n) => ({
            id: n.id_notificacion || n.id_cita || Math.random().toString(36).slice(2),
            id_cita: n.id_cita,
            type: mapTipo(n.tipo),
            title: n.titulo || (n.tipo ? n.tipo.toUpperCase() : "Notificaci√≥n"),
            message: n.mensaje || "",
            client: n.nombre_cliente,
            service: n.nombre_servicio,
            date: n.fecha_cita,
            time: n.hora_inicio,
            timestamp: n.timestamp || new Date().toISOString(),
            read: leidasSet.has(n.id_notificacion || n.id_cita),
            actions: getActionsForType(n.tipo),
          }));

          renderNotifications();
        } catch (err) {
          console.error("Error conexi√≥n notificaciones:", err);
          await showToast("Error de conexi√≥n al cargar notificaciones", "error", 2200);
        }
      }

      function mapTipo(tipo) {
        const map = { nueva: "appointment", cancelada: "cancellation", confirmada: "appointment", completada: "appointment" };
        return map[tipo] || "appointment";
      }
      function getActionsForType(tipo) {
        if (tipo === "nueva") return ["view","confirm"];
        if (tipo === "cancelada") return ["reschedule"];
        if (tipo === "confirmada" || tipo === "completada") return ["view"];
        return ["view"];
      }

      function setupEventListeners() {
        document.querySelectorAll(".notification-tab").forEach((tab) => {
          tab.addEventListener("click", function () {
            document.querySelectorAll(".notification-tab").forEach((t) => t.classList.remove("active"));
            this.classList.add("active");
            currentFilter = this.getAttribute("data-tab");
            renderNotifications();
          });
        });

        document.getElementById("mark-all-read").addEventListener("click", async () => {
          // marcar en localStorage
          const set = getReadSet();
          notifications.forEach(n => set.add(n.id));
          saveReadSet(set);
          notifications.forEach(n => n.read = true);
          renderNotifications();

          // opcional: avisar al backend
          const token = getToken();
          try {
            const ids = notifications.map(n => n.id);
            await fetch(`${API_NOTIFICACIONES}/marcar-leidas`, {
              method: "POST",
              headers: { "Content-Type":"application/json", Authorization:`Bearer ${token}` },
              body: JSON.stringify({ ids })
            });
          } catch (err) {
            console.warn("No se pudo notificar al backend sobre lectura masiva:", err);
          }
          await showToast("Todas las notificaciones marcadas como le√≠das", "success", 1400);
        });
      }

      function renderNotifications() {
        const container = document.getElementById("notification-list");
        container.innerHTML = "";

        let filtered = notifications;
        if (currentFilter === "unread") filtered = notifications.filter((n) => !n.read);
        else if (currentFilter === "appointments") filtered = notifications.filter((n) => n.type === "appointment");
        else if (currentFilter === "changes") filtered = notifications.filter((n) => n.type === "cancellation");

        filtered.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

        if (!filtered.length) {
          const empty = document.createElement("div");
          empty.className = "empty-notifications";
          empty.textContent = "No hay notificaciones para mostrar";
          container.appendChild(empty);
          return;
        }

        filtered.forEach((n) => container.appendChild(createNotificationElement(n)));
      }

      function createNotificationElement(notification) {
        const item = document.createElement("div");
        item.className = `notification-item ${notification.read ? "" : "unread"}`;
        item.dataset.id = notification.id;

        let iconText = notification.type === "appointment" ? "üìÖ" : "‚ùå";
        const timeAgo = getTimeAgo(notification.timestamp);

        let buttonsHtml = "";
        if (notification.actions.includes("view")) buttonsHtml += `<button class="btn btn-primary" data-action="view">Ver Detalles</button>`;
        if (notification.actions.includes("confirm")) buttonsHtml += `<button class="btn btn-success" data-action="confirm">Confirmar</button>`;
        if (notification.actions.includes("reschedule")) buttonsHtml += `<button class="btn btn-warning" data-action="reschedule">Reagendar</button>`;
        if (!notification.read) buttonsHtml += `<button class="btn btn-secondary" data-action="mark-read">Marcar como le√≠da</button>`;

        item.innerHTML = `
          <div class="notification-icon">${iconText}</div>
          <div class="notification-content">
            <div class="notification-message">
              <strong>${notification.title}</strong><br>
              ${notification.message || ""}
              ${notification.client ? `<br><span class="notification-client">Cliente: ${notification.client}</span>` : ""}
              ${notification.service ? `<span class="notification-service"> - ${notification.service}</span>` : ""}
              ${notification.date ? `<br><span class="notification-date">Fecha: ${formatDate(notification.date)} a las ${notification.time}</span>` : ""}
            </div>
            <div class="notification-meta">
              <span class="notification-time">${timeAgo}</span>
              <div class="notification-actions">${buttonsHtml}</div>
            </div>
          </div>
        `;

        item.querySelectorAll("button").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const action = btn.dataset.action;
            await handleNotificationAction(notification, action);
          });
        });

        return item;
      }

      async function handleNotificationAction(notification, action) {
        const token = getToken();
        switch(action) {
          case "view":
            // navegar a agenda con query param (tu c√≥digo en agenda puede interpretar)
            window.location.href = `/templates/barber_agenda.html?cita=${notification.id_cita || notification.id}`;
            break;
          case "confirm":
            {
              const ok = await showConfirm("Confirmar cita", `¬øConfirmar la cita con ${notification.client || ''} para ${notification.service || ''}?`);
              if (!ok) return;
              // llamar endpoint para confirmar cita (debes implementar en backend si no existe)
              try {
                await fetch(`${API_BASE}/citas/${notification.id_cita}/estado`, {
                  method: "PATCH",
                  headers: { "Content-Type":"application/json", Authorization:`Bearer ${token}` },
                  body: JSON.stringify({ estado: "confirmada" })
                });
                await showToast("Cita confirmada", "success", 1400);
                markAsRead(notification.id);
              } catch (err) {
                console.error("Error confirmando cita:", err);
                await showToast("Error al confirmar cita", "error", 1800);
              }
            }
            break;
          case "reschedule":
            // redirigir a agenda con par√°metro de reagendar
            window.location.href = `/templates/barber_agenda.html?reagendar=${notification.id_cita || notification.id}`;
            break;
          case "mark-read":
            await markAsRead(notification.id);
            break;
        }
      }

      async function markAsRead(id) {
        const set = getReadSet();
        set.add(id);
        saveReadSet(set);
        const notif = notifications.find(n => n.id === id);
        if (notif) notif.read = true;
        renderNotifications();

        // intentar marcar en backend (si existe)
        const token = getToken();
        try {
          await fetch(`${API_NOTIFICACIONES}/marcar-leida`, {
            method: "POST",
            headers: { "Content-Type":"application/json", Authorization:`Bearer ${token}` },
            body: JSON.stringify({ id_notificacion: id })
          });
        } catch (err) {
          console.warn("Error marcando le√≠da en backend:", err);
        }
      }

      function formatDate(dateString) {
        if (!dateString) return "";
        const date = new Date(dateString);
        return date.toLocaleDateString("es-ES", { weekday:"long", year:"numeric", month:"long", day:"numeric" });
      }

      function getTimeAgo(timestamp) {
        const now = new Date();
        const t = new Date(timestamp);
        const diffMs = now - t;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        if (diffMins < 1) return "Hace un momento";
        if (diffMins < 60) return `Hace ${diffMins} minuto${diffMins>1?'s':''}`;
        if (diffHours < 24) return `Hace ${diffHours} hora${diffHours>1?'s':''}`;
        if (diffDays < 7) return `Hace ${diffDays} d√≠a${diffDays>1?'s':''}`;
        return t.toLocaleDateString("es-ES");
      }
    </script>
  </body>
</html>
