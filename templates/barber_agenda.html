<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/static/barbera.css" />
    <link rel="stylesheet" href="/static/alerts.css" />
    <title>Agenda</title>
  </head>
  <body>
    <header class="header">
      <div class="block">
        <img
          class="imagen-de-barberia"
          src="/images/barber.jpg"
          alt="Logo Barber Studio"
        />
      </div>
      <nav class="navigation-pill-list" aria-label="Navegación principal">
        <a href="/perfil" class="navigation-pill"
          ><span class="title">Mi Perfil</span></a
        >
        <a href="/homebarber" class="navigation-pill"
          ><span class="title">Inicio</span></a
        >
        <a href="/barber_agenda" class="navigation-pill"
          ><span class="">Agenda</span></a
        >
        <a href="/notibarbero" class="navigation-pill"
          ><span class="title">Notificaciones</span></a
        >
        <a href="/login" class="navigation-pill"
          ><span class="title">Cerrar Sesión</span></a
        >
      </nav>
    </header>

    <main class="main-content">
      <div class="calendar-header">
        <h1 class="calendar-title" id="current-month">Noviembre 2025</h1>
        <div class="calendar-nav">
          <button class="btn btn-secondary" id="prev-month">
            ← Mes Anterior
          </button>
          <button class="btn btn-secondary" id="today">Hoy</button>
          <button class="btn btn-secondary" id="next-month">
            Mes Siguiente →
          </button>
          <button class="btn btn-primary" id="edit-schedule">
            Modificar Horarios
          </button>
        </div>
      </div>

      <div class="calendar-container">
        <div class="calendar-grid" id="calendar"></div>
      </div>

      <div class="day-schedule" id="day-schedule">
        <h2 class="schedule-title" id="selected-day">
          Selecciona un día para ver la agenda
        </h2>
        <p id="available-slots-text"></p>
        <ul id="available-slots-list"></ul>
        <table class="schedule-table">
          <thead>
            <tr>
              <th>Hora</th>
              <th>Estado</th>
              <th>Cliente</th>
              <th>Servicio</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="schedule-body"></tbody>
        </table>
      </div>
    </main>

    <!-- Modal para modificar horarios -->
    <div class="modal" id="schedule-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Modificar Horarios de Trabajo</h2>
          <button class="close-modal" id="close-modal">&times;</button>
        </div>
        <form id="schedule-form">
          <div class="form-group full-width">
            <p>
              Establece los horarios de atención para cada día de la semana. Los
              horarios por defecto son:
            </p>
            <ul>
              <li>Lunes a Jueves: 5:30 PM - 8:00 PM</li>
              <li>Viernes: Cerrado</li>
              <li>Sábado: 2:00 PM - 7:00 PM</li>
              <li>Domingo: 9:00 AM - 9:00 PM</li>
            </ul>
          </div>

          <div class="form-group full-width">
            <h3>Lunes a Jueves</h3>
            <div class="day-checkbox">
              <input type="checkbox" id="mon-thu-active" checked />
              <label for="mon-thu-active">Activo</label>
            </div>
            <div class="schedule-form">
              <div class="form-group">
                <label for="mon-thu-start">Hora de inicio</label>
                <input type="time" id="mon-thu-start" value="17:30" />
              </div>
              <div class="form-group">
                <label for="mon-thu-end">Hora de fin</label>
                <input type="time" id="mon-thu-end" value="20:00" />
              </div>
            </div>
          </div>

          <div class="form-group full-width">
            <h3>Viernes</h3>
            <div class="day-checkbox">
              <input type="checkbox" id="fri-active" />
              <label for="fri-active">Activo</label>
            </div>
            <div class="schedule-form">
              <div class="form-group">
                <label for="fri-start">Hora de inicio</label>
                <input type="time" id="fri-start" value="09:00" disabled />
              </div>
              <div class="form-group">
                <label for="fri-end">Hora de fin</label>
                <input type="time" id="fri-end" value="17:00" disabled />
              </div>
            </div>
          </div>

          <div class="form-group full-width">
            <h3>Sábado</h3>
            <div class="day-checkbox">
              <input type="checkbox" id="sat-active" checked />
              <label for="sat-active">Activo</label>
            </div>
            <div class="schedule-form">
              <div class="form-group">
                <label for="sat-start">Hora de inicio</label>
                <input type="time" id="sat-start" value="14:00" />
              </div>
              <div class="form-group">
                <label for="sat-end">Hora de fin</label>
                <input type="time" id="sat-end" value="19:00" />
              </div>
            </div>
          </div>

          <div class="form-group full-width">
            <h3>Domingo</h3>
            <div class="day-checkbox">
              <input type="checkbox" id="sun-active" checked />
              <label for="sun-active">Activo</label>
            </div>
            <div class="schedule-form">
              <div class="form-group">
                <label for="sun-start">Hora de inicio</label>
                <input type="time" id="sun-start" value="09:00" />
              </div>
              <div class="form-group">
                <label for="sun-end">Hora de fin</label>
                <input type="time" id="sun-end" value="21:00" />
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              id="cancel-schedule"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary">
              Guardar Cambios
            </button>
          </div>
        </form>
      </div>
    </div>

    <div id="modal-estado" class="modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Cambiar estado de cita</h2>
          <button class="close-modal" id="close-modal-estado">&times;</button>
        </div>
        <input type="hidden" id="estado-id-cita" />
        <div class="form-group">
          <label for="estado-nuevo">Nuevo estado</label>
          <select id="estado-nuevo" class="form-select">
            <option value="pendiente">Pendiente</option>
            <option value="confirmada">Confirmada</option>
            <option value="cancelada">Cancelada</option>
            <option value="completada">Completada</option>
          </select>
        </div>
        <div class="form-actions">
          <button id="btn-guardar-estado" class="btn btn-primary">
            Guardar
          </button>
          <button id="btn-cerrar-estado" class="btn btn-secondary">
            Cerrar
          </button>
        </div>
      </div>
    </div>

    <div id="modal-reagendar" class="modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Reagendar cita</h2>
          <button class="close-modal" id="close-modal-reagendar">
            &times;
          </button>
        </div>
        <input type="hidden" id="reagendar-id-cita" />
        <div class="form-group">
          <label for="reagendar-fecha">Nueva fecha</label>
          <input type="date" id="reagendar-fecha" class="form-input" />
        </div>
        <div class="form-group">
          <label for="reagendar-hora">Nueva hora</label>
          <input type="time" id="reagendar-hora" class="form-input" />
        </div>
        <div class="form-actions">
          <button id="btn-guardar-reagendar" class="btn btn-primary">
            Guardar
          </button>
          <button id="btn-cerrar-reagendar" class="btn btn-secondary">
            Cerrar
          </button>
        </div>
      </div>
    </div>

    <footer class="footer">
      <div class="footer-logo">
        <img
          class="imagen-de-barberia"
          src="/images/barber.jpg"
          alt="Barber Studio Logo"
        />
      </div>
      <nav class="text-link-list" aria-labelledby="footer-contact">
        <div class="text-strong-wrapper">
          <h2 id="footer-contact" class="text-strong">
            <span class="text-strong-2">contacto</span>
          </h2>
        </div>
        <ul class="footer-list">
          <li class="text-link-list-item">
            <a href="tel:9837324637" class="list-item">9837324637</a>
          </li>
          <li class="text-link-list-item">
            <a href="mailto:barberpi@utttn.mx" class="list-item-2"
              >barberpi@utttn.mx</a
            >
          </li>
        </ul>
      </nav>
      <nav class="text-link-list" aria-labelledby="footer-location">
        <div class="text-strong-wrapper">
          <h2 id="footer-location" class="text-strong">
            <span class="text-strong-2">ubicación</span>
          </h2>
        </div>
        <ul class="footer-list">
          <li class="text-link-list-item">
            <a
              href="https://maps.app.goo.gl/ZD5gur5vPiwKMVCW9?g_st=iw"
              target="_blank"
              rel="noopener noreferrer"
              class="list-item-7"
              >google.maps/micasa</a
            >
          </li>
        </ul>
      </nav>
      <nav class="text-link-list" aria-labelledby="footer-creator">
        <div class="text-strong-wrapper">
          <h2 id="footer-creator" class="text-strong">
            <span class="">creado por:</span>
          </h2>
        </div>
        <ul class="footer-list">
          <li class="text-link-list-item">
            <span class="list-item-11">Axel Rivera</span>
          </li>
          <li class="text-link-list-item">
            <span class="list-item-12">contactos:</span>
          </li>
          <li class="text-link-list-item">
            <a href="mailto:axel.delgado@uttn.mx" class="list-item-13"
              >axel.delgado@uttn.mx</a
            >
          </li>
          <li class="text-link-list-item">
            <a href="tel:8994287620" class="list-item">8994287620</a>
          </li>
        </ul>
      </nav>
    </footer>

    <div id="app-notify-root">
      <div id="app-toast-container" class="toast-container"></div>
      <div id="app-modal-container"></div>
    </div>

 <script>
  (function notifyHelpers() {
    const toastContainer = document.getElementById("app-toast-container");
    const modalContainer = document.getElementById("app-modal-container");

    window.showToast = function (text = "", type = "info", timeout = 3500) {
      return new Promise((resolve) => {
        if (!toastContainer) {
          console.warn("Toast container missing:", text);
          return resolve();
        }
        const wrap = document.createElement("div");
        wrap.className = `app-toast ${type}`;
        wrap.innerHTML = `<div class="msg">${text}</div><button class="close-btn" aria-label="close">&times;</button>`;
        const closeBtn = wrap.querySelector(".close-btn");
        let removed = false;
        const cleanupToast = () => {
          if (removed) return;
          removed = true;
          wrap.style.opacity = "0";
          setTimeout(() => {
            try { toastContainer.removeChild(wrap); } catch (e) {}
            resolve();
          }, 180);
        };
        closeBtn && closeBtn.addEventListener("click", cleanupToast);
        toastContainer.appendChild(wrap);
        // force reflow if you want animation: void wrap.offsetWidth;
        setTimeout(cleanupToast, timeout || 3500);
      });
    };

    window.showConfirm = function (title = "Confirmar", message = "") {
      return new Promise((resolve) => {
        if (!modalContainer) {
          console.warn("Modal container missing:", title, message);
          return resolve(false);
        }

        // Backdrop
        const backdrop = document.createElement("div");
        backdrop.className = "app-modal-backdrop";
        backdrop.innerHTML = `
          <div class="app-modal" role="dialog" aria-modal="true" aria-labelledby="confirm-title">
            <h3 id="confirm-title">${title}</h3>
            <p>${message}</p>
            <div class="row">
              <button class="app-btn ghost" id="app-cancel-btn">Cancelar</button>
              <button class="app-btn primary" id="app-ok-btn">Aceptar</button>
            </div>
          </div>
        `;

        // Append to DOM
        modalContainer.appendChild(backdrop);

        // Grab elements (pueden ser null en casos extremos)
        const okBtn = backdrop.querySelector("#app-ok-btn");
        const cancelBtn = backdrop.querySelector("#app-cancel-btn");
        const modal = backdrop.querySelector(".app-modal");

        // Focus en aceptar por accesibilidad
        if (okBtn) okBtn.focus();

        let finished = false;
        const cleanup = (value) => {
          if (finished) return;
          finished = true;

          // remover listeners
          try {
            okBtn && okBtn.removeEventListener("click", onOk);
            cancelBtn && cancelBtn.removeEventListener("click", onCancel);
            backdrop.removeEventListener("click", onBackdropClick);
            document.removeEventListener("keydown", onKeyDown);
          } catch (e) {}

          // remueve del DOM con ligera transición
          if (modal) modal.style.opacity = "0.0";
          backdrop.style.opacity = "0";
          setTimeout(() => {
            try { modalContainer.removeChild(backdrop); } catch (e) {}
            resolve(Boolean(value));
          }, 180);
        };

        // Handlers
        const onOk = (ev) => {
          ev && ev.preventDefault();
          cleanup(true);
        };
        const onCancel = (ev) => {
          ev && ev.preventDefault();
          cleanup(false);
        };
        const onBackdropClick = (ev) => {
          // solo click en backdrop (no en el modal)
          if (ev.target === backdrop) cleanup(false);
        };
        const onKeyDown = (ev) => {
          if (ev.key === "Escape" || ev.key === "Esc") {
            cleanup(false);
          } else if (ev.key === "Enter") {
            // opcional: Enter confirma si el foco NO está en cancelar
            // cleanup(true);
          }
        };

        // Attach listeners de forma segura
        cancelBtn && cancelBtn.addEventListener("click", onCancel);
        okBtn && okBtn.addEventListener("click", onOk);
        backdrop.addEventListener("click", onBackdropClick);
        document.addEventListener("keydown", onKeyDown);
      });
    };
  })();

      const API_BASE =
        window.location.hostname.includes("localhost") ||
        window.location.hostname === "127.0.0.1"
          ? "http://localhost:4000/api"
          : `${window.location.origin}/api`;

      console.log("SCRIPT barber_agenda cargado");
      function getToken() {
        return localStorage.getItem("token");
      }
      function getRol() {
        return localStorage.getItem("rol");
      }
      function getUserId() {
        return localStorage.getItem("user_id");
      }

      const BARBERO_ID = getUserId();
      let currentDate = new Date();
      let selectedDate = null;
      let horarioSemanal = {};

      function getTodayDateOnly() {
        const t = new Date();
        t.setHours(0, 0, 0, 0);
        return t;
      }

      document.addEventListener("DOMContentLoaded", async function () {
        console.log("DOMContentLoaded en barber_agenda");
        const token = getToken();
        const rol = getRol();

        if (rol !== "barbero" && rol !== "admin") {
          await showToast(
            "No tienes permisos para acceder a esta página",
            "error",
            2000
          );
          setTimeout(() => {
            window.location.href = "/";
          }, 2000);
          return;
        }

        const hoy = getTodayDateOnly();
        selectedDate = formatDate(hoy);

        await cargarHorarioSemanal();
        generateCalendar(currentDate);
        selectDate(selectedDate);
        setupEventListeners();
      });

      async function cargarHorarioSemanal() {
        const token = getToken();
        try {
          const resp = await fetch(`${API_BASE}/horario-semanal`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!resp.ok) {
            console.error("Error al cargar horario semanal");
            return;
          }
          const data = await resp.json();
          horarioSemanal = {};
          for (const h of data) {
            if (h.activo) {
              horarioSemanal[h.dia_semana] = {
                hora_inicio: h.hora_inicio,
                hora_fin: h.hora_fin,
                duracion_minutos: h.duracion_minutos,
              };
            }
          }
          prellenarModalHorario();
        } catch (err) {
          console.error("Error al cargar horario semanal:", err);
        }
      }

      function prellenarModalHorario() {
        const monThu = horarioSemanal[1] || null;
        if (monThu) {
          document.getElementById("mon-thu-active").checked = true;
          document.getElementById("mon-thu-start").value =
            monThu.hora_inicio.slice(0, 5);
          document.getElementById("mon-thu-end").value = monThu.hora_fin.slice(
            0,
            5
          );
          document.getElementById("mon-thu-start").disabled = false;
          document.getElementById("mon-thu-end").disabled = false;
        } else {
          document.getElementById("mon-thu-active").checked = false;
          document.getElementById("mon-thu-start").disabled = true;
          document.getElementById("mon-thu-end").disabled = true;
        }

        const fri = horarioSemanal[5] || null;
        if (fri) {
          document.getElementById("fri-active").checked = true;
          document.getElementById("fri-start").value = fri.hora_inicio.slice(
            0,
            5
          );
          document.getElementById("fri-end").value = fri.hora_fin.slice(0, 5);
          document.getElementById("fri-start").disabled = false;
          document.getElementById("fri-end").disabled = false;
        } else {
          document.getElementById("fri-active").checked = false;
          document.getElementById("fri-start").disabled = true;
          document.getElementById("fri-end").disabled = true;
        }

        const sat = horarioSemanal[6] || null;
        if (sat) {
          document.getElementById("sat-active").checked = true;
          document.getElementById("sat-start").value = sat.hora_inicio.slice(
            0,
            5
          );
          document.getElementById("sat-end").value = sat.hora_fin.slice(0, 5);
          document.getElementById("sat-start").disabled = false;
          document.getElementById("sat-end").disabled = false;
        } else {
          document.getElementById("sat-active").checked = false;
          document.getElementById("sat-start").disabled = true;
          document.getElementById("sat-end").disabled = true;
        }

        const sun = horarioSemanal[0] || null;
        if (sun) {
          document.getElementById("sun-active").checked = true;
          document.getElementById("sun-start").value = sun.hora_inicio.slice(
            0,
            5
          );
          document.getElementById("sun-end").value = sun.hora_fin.slice(0, 5);
          document.getElementById("sun-start").disabled = false;
          document.getElementById("sun-end").disabled = false;
        } else {
          document.getElementById("sun-active").checked = false;
          document.getElementById("sun-start").disabled = true;
          document.getElementById("sun-end").disabled = true;
        }
      }

      function setupEventListeners() {
        console.log("setupEventListeners ejecutado");
        document
          .getElementById("prev-month")
          .addEventListener("click", function () {
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar(currentDate);
          });

        document
          .getElementById("next-month")
          .addEventListener("click", function () {
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar(currentDate);
          });

        document.getElementById("today").addEventListener("click", function () {
          currentDate = new Date();
          const hoy = getTodayDateOnly();
          selectedDate = formatDate(hoy);
          generateCalendar(currentDate);
          selectDate(selectedDate);
        });

        document
          .getElementById("edit-schedule")
          .addEventListener("click", function () {
            document.getElementById("schedule-modal").style.display = "flex";
          });

        document
          .getElementById("close-modal")
          .addEventListener("click", function () {
            document.getElementById("schedule-modal").style.display = "none";
          });

        document
          .getElementById("cancel-schedule")
          .addEventListener("click", function () {
            document.getElementById("schedule-modal").style.display = "none";
          });

        document
          .getElementById("schedule-form")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            saveScheduleChanges();
          });

        setupCheckboxToggle("mon-thu-active", ["mon-thu-start", "mon-thu-end"]);
        setupCheckboxToggle("fri-active", ["fri-start", "fri-end"]);
        setupCheckboxToggle("sat-active", ["sat-start", "sat-end"]);
        setupCheckboxToggle("sun-active", ["sun-start", "sun-end"]);

        document
          .getElementById("mark-working")
          .addEventListener("click", function () {
            if (selectedDate) markDayAs(selectedDate, "working");
          });

        document
          .getElementById("mark-busy")
          .addEventListener("click", function () {
            if (selectedDate) markDayAs(selectedDate, "busy");
          });

        document
          .getElementById("add-custom")
          .addEventListener("click", function () {
            if (selectedDate) addCustomMessage(selectedDate);
          });

        document
          .getElementById("open-servicios-modal")
          .addEventListener("click", async () => {
            document.getElementById("servicios-modal").style.display = "block";
            await cargarServiciosBarbero();
          });

        document
          .getElementById("close-servicios-modal")
          .addEventListener("click", () => {
            document.getElementById("servicios-modal").style.display = "none";
          });

        document
          .getElementById("close-modal-estado")
          .addEventListener("click", cerrarModalEstado);
        document
          .getElementById("btn-cerrar-estado")
          .addEventListener("click", cerrarModalEstado);
        document
          .getElementById("btn-guardar-estado")
          .addEventListener("click", guardarEstado);

        document
          .getElementById("close-modal-reagendar")
          .addEventListener("click", cerrarModalReagendar);
        document
          .getElementById("btn-cerrar-reagendar")
          .addEventListener("click", cerrarModalReagendar);
        document
          .getElementById("btn-guardar-reagendar")
          .addEventListener("click", guardarReagendar);
      }

      function setupCheckboxToggle(checkboxId, inputIds) {
        const checkbox = document.getElementById(checkboxId);
        const inputs = inputIds.map((id) => document.getElementById(id));
        checkbox.addEventListener("change", function () {
          inputs.forEach((input) => {
            input.disabled = !checkbox.checked;
          });
        });
        inputs.forEach((input) => {
          input.disabled = !checkbox.checked;
        });
      }

      function generateCalendar(date) {
        const calendar = document.getElementById("calendar");
        calendar.innerHTML = "";

        const days = ["Dom", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb"];
        days.forEach((day) => {
          const dayHeader = document.createElement("div");
          dayHeader.className = "calendar-day-header";
          dayHeader.textContent = day;
          calendar.appendChild(dayHeader);
        });

        const monthNames = [
          "Enero",
          "Febrero",
          "Marzo",
          "Abril",
          "Mayo",
          "Junio",
          "Julio",
          "Agosto",
          "Septiembre",
          "Octubre",
          "Noviembre",
          "Diciembre",
        ];
        document.getElementById("current-month").textContent = `${
          monthNames[date.getMonth()]
        } ${date.getFullYear()}`;

        const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
        const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);
        const prevMonthLastDay = new Date(
          date.getFullYear(),
          date.getMonth(),
          0
        ).getDate();
        const startingDay = firstDay.getDay();

        const today = getTodayDateOnly();

        for (let i = startingDay - 1; i >= 0; i--) {
          const d = new Date(
            date.getFullYear(),
            date.getMonth() - 1,
            prevMonthLastDay - i
          );
          const el = createDayElement(d, true, today);
          calendar.appendChild(el);
        }

        for (let i = 1; i <= lastDay.getDate(); i++) {
          const d = new Date(date.getFullYear(), date.getMonth(), i);
          const el = createDayElement(d, false, today);
          calendar.appendChild(el);
        }

        const totalCells = 42;
        const usedCells = startingDay + lastDay.getDate();
        const remaining = totalCells - usedCells;

        for (let i = 1; i <= remaining; i++) {
          const d = new Date(date.getFullYear(), date.getMonth() + 1, i);
          const el = createDayElement(d, true, today);
          calendar.appendChild(el);
        }
      }

      function createDayElement(dateObj, isOtherMonth, todayDateOnly) {
        const dayElement = document.createElement("div");
        dayElement.className = "calendar-day";
        if (isOtherMonth) {
          dayElement.classList.add("other-month");
        }

        const dayNumber = document.createElement("div");
        dayNumber.className = "calendar-day-number";
        dayNumber.textContent = dateObj.getDate();
        dayElement.appendChild(dayNumber);

        const dateOnly = new Date(dateObj);
        dateOnly.setHours(0, 0, 0, 0);

        const dateStr = formatDate(dateObj);
        dayElement.dataset.date = dateStr;
        if (dateOnly < todayDateOnly) {
          dayElement.classList.add("past-day");
        } else {
          dayElement.addEventListener("click", function () {
            selectDate(dateStr);
          });
        }

        if (selectedDate && dateStr === selectedDate) {
          dayElement.classList.add("selected");
        }

        return dayElement;
      }

      function selectDate(dateStr) {
        const prev = document.querySelector(".calendar-day.selected");
        if (prev) prev.classList.remove("selected");

        const days = document.querySelectorAll(".calendar-day");
        for (let day of days) {
          if (day.dataset.date === dateStr) {
            day.classList.add("selected");
            break;
          }
        }

        selectedDate = dateStr;
        updateDaySchedule(dateStr);
      }

      async function updateDaySchedule(dateStr) {
        const date = parseDate(dateStr);
        const dayNames = [
          "Domingo",
          "Lunes",
          "Martes",
          "Miércoles",
          "Jueves",
          "Viernes",
          "Sábado",
        ];
        const monthNames = [
          "Enero",
          "Febrero",
          "Marzo",
          "Abril",
          "Mayo",
          "Junio",
          "Julio",
          "Agosto",
          "Septiembre",
          "Octubre",
          "Noviembre",
          "Diciembre",
        ];

        document.getElementById("selected-day").textContent =
          `${dayNames[date.getDay()]}, ${date.getDate()} de ` +
          `${monthNames[date.getMonth()]} de ${date.getFullYear()}`;

        const scheduleBody = document.getElementById("schedule-body");
        scheduleBody.innerHTML = "";

        const token = getToken();

        try {
          const resp = await fetch(`${API_BASE}/horario-dia?fecha=${dateStr}`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!resp.ok) {
            scheduleBody.innerHTML =
              '<tr><td colspan="5" style="text-align:center;padding:2rem;">Error al cargar horarios</td></tr>';
            return;
          }

          const data = await resp.json();
          const slots = data.slots || [];

          const availableSlotsText = document.getElementById(
            "available-slots-text"
          );
          const availableSlotsList = document.getElementById(
            "available-slots-list"
          );

          availableSlotsText.innerHTML = "";
          availableSlotsList.innerHTML = "";

          if (slots.length === 0) {
            scheduleBody.innerHTML =
              '<tr><td colspan="5" style="text-align:center;padding:2rem;">Día cerrado - Sin horarios de atención</td></tr>';
            availableSlotsText.textContent =
              "Día cerrado - Sin horarios de atención";
            return;
          }

          const citasResp = await fetch(
            `${API_BASE}/citas-dia?fecha=${dateStr}`,
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          let citas = [];
          if (citasResp.ok) {
            citas = await citasResp.json();
          }

          const libres = slots.filter((s) => s.disponible);
          if (libres.length === 0) {
            availableSlotsText.textContent =
              "No quedan horarios libres para este día.";
          } else {
            availableSlotsText.textContent = `Horarios disponibles (${libres.length}):`;
            libres.forEach((slot) => {
              const li = document.createElement("li");
              li.textContent = slot.hora;
              availableSlotsList.appendChild(li);
            });
          }

          slots.forEach((slot) => {
            const cita = citas.find((c) => c.hora.slice(0, 5) === slot.hora);

            const row = document.createElement("tr");

            const timeCell = document.createElement("td");
            timeCell.textContent = slot.hora;
            row.appendChild(timeCell);

            const statusCell = document.createElement("td");
            let statusText = "";
            let statusClass = "";
            if (!slot.disponible) {
              if (cita) {
                statusText = cita.estado;
                statusClass = "status-busy";
              } else {
                statusText = "Ocupado";
                statusClass = "status-busy";
              }
            } else {
              statusText = "Libre";
              statusClass = "status-free";
            }
            statusCell.textContent = statusText;
            statusCell.className = statusClass;
            row.appendChild(statusCell);

            const clientCell = document.createElement("td");
            clientCell.textContent = cita
              ? cita.cliente_nombre || cita.nombre_usuario || cita.id_usuario
              : "-";
            row.appendChild(clientCell);

            const serviceCell = document.createElement("td");
            serviceCell.textContent = cita
              ? cita.servicio_nombre || cita.servicio || "-"
              : "-";
            row.appendChild(serviceCell);

            const actionsCell = document.createElement("td");
            const actionsDiv = document.createElement("div");
            actionsDiv.className = "action-buttons";

            if (slot.disponible) {
              const busyBtn = document.createElement("button");
              busyBtn.className = "btn btn-warning";
              busyBtn.textContent = "Ocupar";
              busyBtn.addEventListener("click", () =>
                marcarSlot(dateStr, slot.hora, "busy")
              );
              actionsDiv.appendChild(busyBtn);
            } else if (cita) {
              const estadoBtn = document.createElement("button");
              estadoBtn.className = "btn btn-primary";
              estadoBtn.textContent = "Estado";
              estadoBtn.addEventListener("click", () =>
                abrirModalEstado(cita.id_cita)
              );
              actionsDiv.appendChild(estadoBtn);

              const liberarBtn = document.createElement("button");
              liberarBtn.className = "btn btn-secondary";
              liberarBtn.textContent = "Liberar";
              liberarBtn.addEventListener("click", async () => {
                const ok = await showConfirm(
                  "Liberar cita",
                  "¿Estás seguro que quieres liberar esta cita?"
                );
                if (ok) liberarSlot(selectedDate, cita.id_cita);
              });
              actionsDiv.appendChild(liberarBtn);

              const reagendarBtn = document.createElement("button");
              reagendarBtn.className = "btn btn-secondary";
              reagendarBtn.textContent = "Reagendar";
              reagendarBtn.addEventListener("click", () =>
                abrirModalReagendar(cita.id_cita)
              );
              actionsDiv.appendChild(reagendarBtn);
            } else {
              const freeBtn = document.createElement("button");
              freeBtn.className = "btn btn-primary";
              freeBtn.textContent = "Liberar";
              freeBtn.addEventListener("click", async () => {
                const ok = await showConfirm(
                  "Liberar slot",
                  "¿Estás seguro que quieres liberar este slot?"
                );
                if (ok) liberarSlot(dateStr, slot.hora);
              });
              actionsDiv.appendChild(freeBtn);
            }

            actionsCell.appendChild(actionsDiv);
            row.appendChild(actionsCell);

            scheduleBody.appendChild(row);
          });
        } catch (err) {
          console.error("Error al cargar agenda del día:", err);
          scheduleBody.innerHTML =
            '<tr><td colspan="5" style="text-align:center;padding:2rem;">Error de conexión</td></tr>';
        }
      }

      function abrirModalEstado(id_cita) {
        document.getElementById("estado-id-cita").value = id_cita;
        document.getElementById("modal-estado").style.display = "flex";
      }

      function cerrarModalEstado() {
        document.getElementById("modal-estado").style.display = "none";
      }

      async function guardarEstado() {
        const id_cita = document.getElementById("estado-id-cita").value;
        const estado = document.getElementById("estado-nuevo").value;
        const token = getToken();
        try {
          const resp = await fetch(`${API_BASE}/citas/${id_cita}/estado`, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ estado }),
          });
          const data = await resp.json();
          if (!resp.ok) {
            await showToast(
              data.error || "Error al actualizar estado",
              "error",
              2500
            );
            return;
          }
          await showToast("Estado actualizado", "success", 1500);
          cerrarModalEstado();
          updateDaySchedule(selectedDate);
        } catch (err) {
          console.error("Error al cambiar estado:", err);
          await showToast("Error de conexión", "error", 2000);
        }
      }

      function abrirModalReagendar(id_cita) {
        document.getElementById("reagendar-id-cita").value = id_cita;
        document.getElementById("reagendar-fecha").value = "";
        document.getElementById("reagendar-hora").value = "";
        document.getElementById("modal-reagendar").style.display = "flex";
      }

      function cerrarModalReagendar() {
        document.getElementById("modal-reagendar").style.display = "none";
      }

      async function guardarReagendar() {
        const id_cita = document.getElementById("reagendar-id-cita").value;
        const fecha = document.getElementById("reagendar-fecha").value;
        const hora = document.getElementById("reagendar-hora").value;
        const token = getToken();
        if (!fecha || !hora) {
          await showToast("Fecha y hora son obligatorias", "warning", 2000);
          return;
        }
        const horaFull = hora.length === 5 ? hora + ":00" : hora;
        try {
          const resp = await fetch(`${API_BASE}/citas/${id_cita}/reagendar`, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ fecha, hora: horaFull }),
          });
          const data = await resp.json();
          if (!resp.ok) {
            await showToast(
              data.error || "Error al reagendar cita",
              "error",
              2500
            );
            return;
          }
          await showToast("Cita reagendada", "success", 1500);
          cerrarModalReagendar();
          updateDaySchedule(selectedDate);
        } catch (err) {
          console.error("Error al reagendar cita:", err);
          await showToast("Error de conexión", "error", 2000);
        }
      }

      async function marcarSlot(dateStr, hora, tipo) {
        const token = getToken();
        try {
          const resp = await fetch(`${API_BASE}/marcar-slot`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ fecha: dateStr, hora, tipo }),
          });
          if (!resp.ok) {
            await showToast("Error al marcar slot", "error", 2000);
            return;
          }
          updateDaySchedule(dateStr);
        } catch (err) {
          console.error("Error al marcar slot:", err);
          await showToast("Error de conexión", "error", 2000);
        }
      }

      async function liberarSlot(dateStr, id_cita) {
        const token = getToken();
        try {
          const resp = await fetch(`${API_BASE}/liberar-slot`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ id_cita }),
          });
          if (!resp.ok) {
            const data = await resp.json().catch(() => ({}));
            await showToast(
              data.error || "Error al liberar slot",
              "error",
              2500
            );
            return;
          }
          updateDaySchedule(dateStr);
        } catch (err) {
          console.error("Error al liberar slot:", err);
          await showToast("Error de conexión", "error", 2000);
        }
      }

      function normalizeTimeToSeconds(t) {
        if (!t) return null;
        if (t.length === 5) return t + ":00";
        return t;
      }

      async function saveScheduleChanges() {
        const token = getToken();
        const horarios = [];

        const monThuActive = document.getElementById("mon-thu-active").checked;
        if (monThuActive) {
          let start = normalizeTimeToSeconds(
            document.getElementById("mon-thu-start").value
          );
          let end = normalizeTimeToSeconds(
            document.getElementById("mon-thu-end").value
          );
          if (!start || !end) {
            await showToast(
              "Debes ingresar hora de inicio y fin para Lunes a Jueves",
              "warning",
              2500
            );
            return;
          }
          for (let d = 1; d <= 4; d++) {
            horarios.push({
              dia_semana: d,
              hora_inicio: start,
              hora_fin: end,
              duracion_minutos: 45,
              activo: true,
            });
          }
        }

        const friActive = document.getElementById("fri-active").checked;
        if (friActive) {
          let start = normalizeTimeToSeconds(
            document.getElementById("fri-start").value
          );
          let end = normalizeTimeToSeconds(
            document.getElementById("fri-end").value
          );
          if (!start || !end) {
            await showToast(
              "Debes ingresar hora de inicio y fin para Viernes",
              "warning",
              2500
            );
            return;
          }
          horarios.push({
            dia_semana: 5,
            hora_inicio: start,
            hora_fin: end,
            duracion_minutos: 45,
            activo: true,
          });
        }

        const satActive = document.getElementById("sat-active").checked;
        if (satActive) {
          let start = normalizeTimeToSeconds(
            document.getElementById("sat-start").value
          );
          let end = normalizeTimeToSeconds(
            document.getElementById("sat-end").value
          );
          if (!start || !end) {
            await showToast(
              "Debes ingresar hora de inicio y fin para Sábado",
              "warning",
              2500
            );
            return;
          }
          horarios.push({
            dia_semana: 6,
            hora_inicio: start,
            hora_fin: end,
            duracion_minutos: 45,
            activo: true,
          });
        }

        const sunActive = document.getElementById("sun-active").checked;
        if (sunActive) {
          let start = normalizeTimeToSeconds(
            document.getElementById("sun-start").value
          );
          let end = normalizeTimeToSeconds(
            document.getElementById("sun-end").value
          );
          if (!start || !end) {
            await showToast(
              "Debes ingresar hora de inicio y fin para Domingo",
              "warning",
              2500
            );
            return;
          }
          horarios.push({
            dia_semana: 0,
            hora_inicio: start,
            hora_fin: end,
            duracion_minutos: 45,
            activo: true,
          });
        }

        try {
          const resp = await fetch(`${API_BASE}/horario-semanal`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ horarios }),
          });
          if (!resp.ok) {
            const errorText = await resp.text();
            console.error("Error al guardar horarios:", resp.status, errorText);
            await showToast("Error al guardar horarios", "error", 2500);
            return;
          }
          await showToast(
            "Horarios actualizados correctamente",
            "success",
            1500
          );
          document.getElementById("schedule-modal").style.display = "none";
          await cargarHorarioSemanal();
          if (selectedDate) {
            updateDaySchedule(selectedDate);
          }
        } catch (err) {
          console.error("Error al guardar horarios:", err);
          await showToast("Error de conexión", "error", 2000);
        }
      }

      function formatDate(d) {
        return (
          d.getFullYear() +
          "-" +
          String(d.getMonth() + 1).padStart(2, "0") +
          "-" +
          String(d.getDate()).padStart(2, "0")
        );
      }

      function parseDate(str) {
        const [y, m, d] = str.split("-").map((n) => parseInt(n));
        return new Date(y, m - 1, d);
      }
    </script>
  </body>
</html>
