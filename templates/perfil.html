<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Barber Studio - Perfil</title>
    <link rel="stylesheet" href="../static/perfil.css" />
  </head>
  <body>
    <header class="header">
      <div class="block">
        <img
          class="imagen-de-barberia"
          src="../images/barber.jpg"
          alt="Logo Barber Studio"
        />
      </div>
      <nav
        id="main-nav"
        class="navigation-pill-list"
        aria-label="Navegación principal"
      ></nav>
    </header>

    <main class="main-content">
      <div class="profile-container">
        <div class="profile-header">
          <div class="photo-upload">
            <img
              id="profile-picture"
              class="profile-picture"
              src="../images/avatardefault.webp"
              alt="Foto de perfil"
            />
            <button
              type="button"
              class="btn btn-secondary"
              onclick="openPhotoModal()"
            >
              Cambiar foto
            </button>
          </div>
          <div class="profile-info">
            <h1 class="profile-name" id="display-name">:</h1>
            <p class="profile-role" id="display-role">Cliente</p>
            <p class="profile-id">ID: <span id="display-id">#</span></p>
          </div>
        </div>

        <form id="profile-form" class="profile-form">
          <input type="hidden" id="id_usuario" name="id_usuario" value="" />

          <div class="form-group">
            <label for="nombre">Nombre</label>
            <input type="text" id="nombre" name="nombre" value="" />
          </div>

          <div class="form-group">
            <label for="apellidoP">Apellido Paterno</label>
            <input type="text" id="apellidoP" name="apellidoP" />
          </div>

          <div class="form-group">
            <label for="apellidoM">Apellido Materno</label>
            <input type="text" id="apellidoM" name="apellidoM" />
          </div>

          <div class="form-group">
            <label for="edad">Edad</label>
            <input type="number" id="edad" name="edad" min="7" max="100" />
          </div>

          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" />
          </div>

          <div class="form-group">
            <label for="telefono">Teléfono</label>
            <input type="tel" id="telefono" name="telefono" />
          </div>

          <div class="form-group">
            <label for="rol">Rol</label>
            <select id="rol" name="rol" required>
              <option value="cliente">Cliente</option>
              <option value="barbero">Barbero</option>
              <option value="admin">Administrador</option>
            </select>
          </div>
          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="resetForm()"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary">
              Guardar Cambios
            </button>
          </div>
        </form>
      </div>
    </main>
    <div id="photo-modal" class="modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Cambiar Foto de Perfil</h2>
          <button class="close-btn" onclick="closePhotoModal()">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="photo-preview-container">
            <img
              id="photo-preview"
              class="photo-preview"
              src="../images/avatardefault.webp"
              alt="Vista previa"
            />
          </div>
          <div class="file-input-wrapper">
            <input
              type="file"
              id="photo-file-input"
              accept="image/*"
              style="display: none"
            />
            <button
              type="button"
              class="btn btn-secondary"
              onclick="document.getElementById('photo-file-input').click()"
            >
              <i class="fa-solid fa-image"></i> Seleccionar imagen
            </button>
            <p id="file-name" class="file-name-display">
              Ningún archivo seleccionado
            </p>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            onclick="closePhotoModal()"
          >
            Cancelar
          </button>
          <button type="button" class="btn btn-primary" onclick="uploadPhoto()">
            <i class="fa-solid fa-upload"></i> Subir foto
          </button>
        </div>
      </div>
    </div>
    <footer class="footer">
      <div class="footer-logo">
        <img
          class="imagen-de-barberia"
          src="/barberpi/images/barber.jpg"
          alt="Barber Studio Logo"
        />
      </div>
      <nav class="text-link-list" aria-labelledby="footer-contact">
        <div class="text-strong-wrapper">
          <h2 id="footer-contact" class="text-strong">
            <span class="text-strong-2">contacto</span>
          </h2>
        </div>
        <ul class="footer-list">
          <li class="text-link-list-item">
            <a href="tel:9837324637" class="list-item">9837324637</a>
          </li>
          <li class="text-link-list-item">
            <a href="mailto:barberpi@utttn.mx" class="list-item-2"
              >barberpi@utttn.mx</a
            >
          </li>
        </ul>
      </nav>
      <nav class="text-link-list" aria-labelledby="footer-location">
        <div class="text-strong-wrapper">
          <h2 id="footer-location" class="text-strong">
            <span class="text-strong-2">ubicación</span>
          </h2>
        </div>
        <ul class="footer-list">
          <li class="text-link-list-item">
            <a
              href="https://maps.app.goo.gl/ZD5gur5vPiwKMVCW9?g_st=iw"
              target="_blank"
              rel="noopener noreferrer"
              class="list-item-7"
              >google.maps/micasa</a
            >
          </li>
        </ul>
      </nav>
      <nav class="text-link-list" aria-labelledby="footer-creator">
        <div class="text-strong-wrapper">
          <h2 id="footer-creator" class="text-strong">
            <span class="">creado por:</span>
          </h2>
        </div>
        <ul class="footer-list">
          <li class="text-link-list-item">
            <span class="list-item-11">Axel Rivera</span>
          </li>
          <li class="text-link-list-item">
            <span class="list-item-12">contactos:</span>
          </li>
          <li class="text-link-list-item">
            <a href="mailto:axel.delgado@uttn.mx" class="list-item-13"
              >axel.delgado@uttn.mx</a
            >
          </li>
          <li class="text-link-list-item">
            <a href="tel:8994287620" class="list-item">8994287620</a>
          </li>
        </ul>
      </nav>
    </footer>
    <script>
      const API_AUTH = "http://localhost:4000/api/auth";

      function getToken() {
        return localStorage.getItem("token");
      }

      function getRol() {
        return localStorage.getItem("rol");
      }

      let currentUser = null;
      let currentRol = null;
      let selectedPhotoFile = null;

      const nav_by_rol = {
        cliente: [
          { href: "../templates/perfil.html", label: "Mi Información" },
          { href: "../templates/home.html", label: "Inicio" },
          { href: "../templates/agendar.html", label: "Agendar Cita" },
          {
            href: "../templates/notificacion.html",
            label: "Notificaciones",
          },
          { href: "../templates/login.html", label: "Cerrar Sesión" },
        ],
        barbero: [
          { href: "../templates/perfil.html", label: "Mi Información" },
          {
            href: "../templates/homebarber.html",
            label: "Inicio",
          },
          {
            href: "../templates/barber_agenda.html",
            label: "Agendar",
          },
          {
            href: "../templates/notibarbero.html",
            label: "Notificaciones",
          },
          {
            href: "../templates/login.html",
            label: "Cerrar Sesión",
          },
        ],
        admin: [
          { href: "../templates/perfil.html", label: "Mi Información" },
          {
            href: "../templates/homebarber.html",
            label: "Inicio",
          },
          {
            href: "../templates/barber_agenda.html",
            label: "Agendar",
          },
          {
            href: "../templates/notibarbero.html",
            label: "Notificaciones",
          },
          {
            href: "../templates/login.html",
            label: "Cerrar Sesión",
          },
        ],
      };
      function renderNavByRole(role) {
        const nav = document.getElementById("main-nav");
        if (!nav) return;

        const items = nav_by_rol[role] || nav_by_rol["cliente"];

        nav.innerHTML = "";

        items.forEach((item) => {
          const a = document.createElement("a");
          a.className = "navigation-pill";
          a.href = item.href || "#";
          const span = document.createElement("span");
          span.className = "title";
          span.textContent = item.label;
          a.appendChild(span);
          nav.appendChild(a);
        });
      }

      document.addEventListener("DOMContentLoaded", async function () {
        const token = getToken();
        const rol = getRol();
        currentRol = rol;

        if (!token) {
          alert("Debes iniciar sesión");
          window.location.href = "/barberpi/templates/login.html";
          return;
        }

        try {
          const resp = await fetch(`${API_AUTH}/perfil`, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (resp.status === 401) {
            alert("Sesión expirada. Vuelve a iniciar sesión.");
            localStorage.removeItem("token");
            localStorage.removeItem("rol");
            window.location.href = "/barberpi/templates/login.html";
            return;
          }

          if (!resp.ok) {
            const data = await resp.json().catch(() => ({}));
            alert(data.error || "No se pudo cargar el perfil");
            return;
          }

          currentUser = await resp.json();
          renderNavByRole(currentRol);
          loadUserDataFromBackend(currentUser);
          configureRoleFieldByPermission();

          document
            .getElementById("photo-file-input")
            .addEventListener("change", function (e) {
              if (e.target.files && e.target.files[0]) {
                selectedPhotoFile = e.target.files[0];
                document.getElementById("file-name").textContent =
                  selectedPhotoFile.name;

                const reader = new FileReader();
                reader.onload = function (e2) {
                  document.getElementById("photo-preview").src =
                    e2.target.result;
                };
                reader.readAsDataURL(selectedPhotoFile);
              }
            });

          document
            .getElementById("profile-form")
            .addEventListener("submit", function (e) {
              e.preventDefault();
              saveUserDataToBackend();
            });
        } catch (err) {
          console.error("Error al cargar perfil:", err);
          alert("Error de conexión al cargar tu perfil");
        }
      });

      function loadUserDataFromBackend(user) {
        document.getElementById("id_usuario").value = user.id_usuario;
        document.getElementById("nombre").value = user.nombre || "";
        document.getElementById("apellidoP").value = user.apellidoP || "";
        document.getElementById("apellidoM").value = user.apellidoM || "";
        document.getElementById("edad").value = user.edad || "";
        document.getElementById("email").value = user.email || "";
        document.getElementById("telefono").value = user.telefono || "";
        document.getElementById("rol").value = user.rol || "cliente";

        updateDisplay(user);
      }

      function updateDisplay(user) {
        const nombreCompleto = `${user.nombre || ""} ${user.apellidoP || ""} ${
          user.apellidoM || ""
        }`.trim();

        document.getElementById("display-name").textContent =
          nombreCompleto || "Ingresa tus datos";
        document.getElementById("display-role").textContent =
          (user.rol || "cliente").charAt(0).toUpperCase() +
          (user.rol || "cliente").slice(1);
        document.getElementById("display-id").textContent =
          user.id_usuario || "-";

        const fotoUrl =
          user.foto_perfil || "/barberpi/images/default-avatar.jpg";
        const fotoCompleta = fotoUrl.startsWith("http")
          ? fotoUrl
          : `http://localhost:4000${fotoUrl}`;

        document.getElementById("profile-picture").src = fotoCompleta;
        document.getElementById("photo-preview").src = fotoCompleta;
      }

      function configureRoleFieldByPermission() {
        const rolSelect = document.getElementById("rol");

        if (!rolSelect) return;

        if (currentRol === "admin") {
          rolSelect.disabled = false;
        } else {
          rolSelect.disabled = true;
        }
      }

      function openPhotoModal() {
        document.getElementById("photo-modal").style.display = "flex";
        selectedPhotoFile = null;
        document.getElementById("file-name").textContent =
          "Ningún archivo seleccionado";
        document.getElementById("photo-file-input").value = "";

        const fotoActual =
          currentUser.foto_perfil || "/barberpi/images/default-avatar.jpg";
        const fotoCompleta = fotoActual.startsWith("http")
          ? fotoActual
          : `http://localhost:4000${fotoActual}`;
        document.getElementById("photo-preview").src = fotoCompleta;
      }

      function closePhotoModal() {
        document.getElementById("photo-modal").style.display = "none";
        selectedPhotoFile = null;
        document.getElementById("file-name").textContent =
          "Ningún archivo seleccionado";
        document.getElementById("photo-file-input").value = "";
      }

      async function uploadPhoto() {
        if (!selectedPhotoFile) {
          alert("Por favor, selecciona una imagen primero");
          return;
        }

        const token = getToken();
        const formData = new FormData();
        formData.append("foto", selectedPhotoFile);

        try {
          const resp = await fetch(`${API_AUTH}/perfil/foto`, {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });

          const data = await resp.json().catch(() => ({}));

          if (!resp.ok) {
            alert(data.error || "Error al subir la foto");
            return;
          }

          currentUser.foto_perfil = data.foto_perfil;
          updateDisplay(currentUser);

          closePhotoModal();
          alert("Foto de perfil actualizada correctamente");
        } catch (err) {
          console.error("Error al subir foto:", err);
          alert("Error de conexión al subir la foto");
        }
      }

      async function saveUserDataToBackend() {
        const token = getToken();
        if (!token) {
          alert("Debes iniciar sesión");
          window.location.href = "/barberpi/templates/login.html";
          return;
        }

        const body = {
          nombre: document.getElementById("nombre").value.trim(),
          apellidoP: document.getElementById("apellidoP").value.trim(),
          apellidoM: document.getElementById("apellidoM").value.trim(),
          edad: parseInt(document.getElementById("edad").value, 10) || null,
          email: document.getElementById("email").value.trim(),
          telefono: document.getElementById("telefono").value.trim(),
          foto_perfil: currentUser.foto_perfil,
          rol:
            currentRol === "admin"
              ? document.getElementById("rol").value
              : currentUser.rol,
        };

        try {
          const resp = await fetch(`${API_AUTH}/perfil`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(body),
          });

          const data = await resp.json().catch(() => ({}));

          if (!resp.ok) {
            alert(data.error || "No se pudo actualizar el perfil");
            return;
          }

          currentUser = {
            ...currentUser,
            ...body,
          };

          updateDisplay(currentUser);

          if (currentRol === "admin" && currentUser.rol !== currentRol) {
            localStorage.setItem("rol", currentUser.rol);
            currentRol = currentUser.rol;
            configureRoleFieldByPermission();
          }

          alert("Perfil actualizado correctamente");
        } catch (err) {
          console.error("Error al actualizar perfil:", err);
          alert("Error de conexión al actualizar el perfil");
        }
      }

      function resetForm() {
        if (currentUser) {
          loadUserDataFromBackend(currentUser);
          configureRoleFieldByPermission();
        }
      }
    </script>
  </body>
</html>
