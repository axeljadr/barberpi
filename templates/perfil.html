<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Barber Studio - Perfil</title>
    <link rel="stylesheet" href="/static/perfil.css" />
  </head>
  <body>
    <header class="header">
      <div class="block">
        <img
          class="imagen-de-barberia"
          src="/images/barber.jpg"
          alt="Logo Barber Studio"
        />
      </div>
      <nav
        id="main-nav"
        class="navigation-pill-list"
        aria-label="Navegación principal"
      ></nav>
    </header>

    <main class="main-content">
      <div class="profile-container">
        <div class="profile-header">
          <div class="photo-upload">
            <img
              id="profile-picture"
              class="profile-picture"
              src="/images/avatardefault.webp"
              alt="Foto de perfil"
            />
            <button
              type="button"
              class="btn btn-secondary"
              onclick="openPhotoModal()"
            >
              Cambiar foto
            </button>
          </div>
          <div class="profile-info">
            <h1 class="profile-name" id="display-name">:</h1>
            <p class="profile-role" id="display-role">Cliente</p>
            <p class="profile-id">ID: <span id="display-id">#</span></p>
          </div>
        </div>

        <form id="profile-form" class="profile-form">
          <input type="hidden" id="id_usuario" name="id_usuario" value="" />

          <div class="form-group">
            <label for="nombre">Nombre</label>
            <input type="text" id="nombre" name="nombre" value="" />
          </div>

          <div class="form-group">
            <label for="apellidoP">Apellido Paterno</label>
            <input type="text" id="apellidoP" name="apellidoP" />
          </div>

          <div class="form-group">
            <label for="apellidoM">Apellido Materno</label>
            <input type="text" id="apellidoM" name="apellidoM" />
          </div>

          <div class="form-group">
            <label for="edad">Edad</label>
            <input type="number" id="edad" name="edad" min="7" max="100" />
          </div>

          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" />
          </div>

          <div class="form-group">
            <label for="telefono">Teléfono</label>
            <input type="tel" id="telefono" name="telefono" />
          </div>

          <div class="form-group">
            <label for="rol">Rol</label>
            <select id="rol" name="rol" required>
              <option value="cliente">Cliente</option>
              <option value="barbero">Barbero</option>
              <option value="admin">Administrador</option>
            </select>
          </div>
          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="resetForm()"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary">
              Guardar Cambios
            </button>
          </div>
        </form>
      </div>
    </main>
    <div id="photo-modal" class="modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Cambiar Foto de Perfil</h2>
          <button class="close-btn" onclick="closePhotoModal()">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="photo-preview-container">
            <img
              id="photo-preview"
              class="photo-preview"
              src="/images/avatardefault.webp"
              alt="Vista previa"
            />
          </div>
          <div class="file-input-wrapper">
            <input
              type="file"
              id="photo-file-input"
              accept="image/*"
              style="display: none"
            />
            <button
              type="button"
              class="btn btn-secondary"
              onclick="document.getElementById('photo-file-input').click()"
            >
              <i class="fa-solid fa-image"></i> Seleccionar imagen
            </button>
            <p id="file-name" class="file-name-display">
              Ningún archivo seleccionado
            </p>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            onclick="closePhotoModal()"
          >
            Cancelar
          </button>
          <button type="button" class="btn btn-primary" onclick="uploadPhoto()">
            <i class="fa-solid fa-upload"></i> Subir foto
          </button>
        </div>
      </div>
    </div>

    <div id="app-notify-root">
      <div id="app-toast-container" class="toast-container"></div>
      <div id="app-modal-container"></div>
    </div>

    <footer class="footer">
      <div class="footer-logo">
        <img
          class="imagen-de-barberia"
          src="/images/barber.jpg"
          alt="Barber Studio Logo"
        />
      </div>
      <nav class="text-link-list" aria-labelledby="footer-contact">
        <div class="text-strong-wrapper">
          <h2 id="footer-contact" class="text-strong">
            <span class="text-strong-2">contacto</span>
          </h2>
        </div>
        <ul class="footer-list">
          <li class="text-link-list-item">
            <a href="tel:9837324637" class="list-item">9837324637</a>
          </li>
          <li class="text-link-list-item">
            <a href="mailto:barberpi@utttn.mx" class="list-item-2"
              >barberpi@utttn.mx</a
            >
          </li>
        </ul>
      </nav>
      <nav class="text-link-list" aria-labelledby="footer-location">
        <div class="text-strong-wrapper">
          <h2 id="footer-location" class="text-strong">
            <span class="text-strong-2">ubicación</span>
          </h2>
        </div>
        <ul class="footer-list">
          <li class="text-link-list-item">
            <a
              href="https://maps.app.goo.gl/ZD5gur5vPiwKMVCW9?g_st=iw"
              target="_blank"
              rel="noopener noreferrer"
              class="list-item-7"
              >google.maps/micasa</a
            >
          </li>
        </ul>
      </nav>
      <nav class="text-link-list" aria-labelledby="footer-creator">
        <div class="text-strong-wrapper">
          <h2 id="footer-creator" class="text-strong">
            <span class="">creado por:</span>
          </h2>
        </div>
        <ul class="footer-list">
          <li class="text-link-list-item">
            <span class="list-item-11">Axel Rivera</span>
          </li>
          <li class="text-link-list-item">
            <span class="list-item-12">contactos:</span>
          </li>
          <li class="text-link-list-item">
            <a href="mailto:axel.delgado@uttn.mx" class="list-item-13"
              >axel.delgado@uttn.mx</a
            >
          </li>
          <li class="text-link-list-item">
            <a href="tel:8994287620" class="list-item">8994287620</a>
          </li>
        </ul>
      </nav>
    </footer>
    <script>
      const API_BASE =
        window.location.hostname.includes("localhost") ||
        window.location.hostname === "127.0.0.1"
          ? "http://localhost:4000"
          : window.location.origin;

      const API_AUTH = `${API_BASE}/api/auth`;

      function getToken() {
        return localStorage.getItem("token");
      }

      function getRol() {
        return localStorage.getItem("rol");
      }

      let currentUser = null;
      let currentRol = null;
      let selectedPhotoFile = null;

      const nav_by_rol = {
        cliente: [
          { href: "/perfil", label: "Mi Información" },
          { href: "/home", label: "Inicio" },
          { href: "/agendar", label: "Agendar Cita" },
          { href: "/notificacion", label: "Notificaciones" },
          { href: "/", label: "Cerrar Sesión" },
        ],
        barbero: [
          { href: "/perfil", label: "Mi Información" },
          { href: "/homebarber", label: "Inicio" },
          { href: "/barber_agenda", label: "Agenda" },
          { href: "/notibarbero", label: "Notificaciones" },
          { href: "/", label: "Cerrar Sesión" },
        ],
        admin: [
          { href: "/perfil", label: "Mi Información" },
          { href: "/homebarber", label: "Inicio" },
          { href: "/barber_agenda", label: "Agenda" },
          { href: "/notibarbero", label: "Notificaciones" },
          { href: "/", label: "Cerrar Sesión" },
        ],
      };
      (function notifyHelpers() {
        const toastContainer = document.getElementById("app-toast-container");
        const modalContainer = document.getElementById("app-modal-container");

        window.showToast = function (text = "", type = "info", timeout = 3500) {
          return new Promise((resolve) => {
            if (!toastContainer) {
              console.warn("Toast container missing:", text);
              return resolve();
            }
            const wrap = document.createElement("div");
            wrap.className = `app-toast ${type}`;
            wrap.innerHTML = `<div class="msg">${text}</div><button class="close-btn" aria-label="close">&times;</button>`;
            const closeBtn = wrap.querySelector(".close-btn");
            let removed = false;
            const cleanup = () => {
              if (removed) return;
              removed = true;
              wrap.style.opacity = "0";
              setTimeout(() => {
                try {
                  toastContainer.removeChild(wrap);
                } catch (e) {}
                resolve();
              }, 180);
            };
            closeBtn.addEventListener("click", cleanup);
            toastContainer.appendChild(wrap);
            setTimeout(cleanup, timeout || 3500);
          });
        };

        window.showConfirm = function (title = "Confirmar", message = "") {
          return new Promise((resolve) => {
            if (!modalContainer) {
              console.warn("Modal container missing:", title, message);
              return resolve(false);
            }
            const backdrop = document.createElement("div");
            backdrop.className = "app-modal-backdrop";
            backdrop.innerHTML = `
        <div class="app-modal" role="dialog" aria-modal="true">
          <h3>${title}</h3>
          <p>${message}</p>
          <div class="row">
            <button class="app-btn ghost" id="app-cancel-btn">Cancelar</button>
            <button class="app-btn primary" id="app-ok-btn">Aceptar</button>
          </div>
        </div>
      `;
            modalContainer.appendChild(backdrop);
            const ok = backdrop.querySelector("#app-ok-btn");
            const cancel = backdrop.querySelector("#app-cancel-btn");
            const cleanup = (value) => {
              try {
                modalContainer.removeChild(backdrop);
              } catch (e) {}
              resolve(Boolean(value));
            };
            cancel.addEventListener("click", () => cleanup(false));
            ok.addEventListener("click", () => cleanup(true));
            backdrop.addEventListener("click", (ev) => {
              if (ev.target === backdrop) cleanup(false);
            });
          });
        };
      })();

      function renderNavByRole(role) {
        const nav = document.getElementById("main-nav");
        if (!nav) return;

        const items = nav_by_rol[role] || nav_by_rol["cliente"];

        nav.innerHTML = "";

        items.forEach((item) => {
          const a = document.createElement("a");
          a.className = "navigation-pill";
          a.href = item.href || "#";
          const span = document.createElement("span");
          span.className = "title";
          span.textContent = item.label;
          a.appendChild(span);
          nav.appendChild(a);
        });
      }

      document.addEventListener("DOMContentLoaded", async function () {
        const token = getToken();
        const rol = getRol();
        currentRol = rol;

        if (!token) {
          await showToast("Debes iniciar sesión", "warning", 1400);
          window.location.href = "/";
          return;
        }

        try {
          const resp = await fetch(`${API_AUTH}/perfil`, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (resp.status === 401) {
            await showToast(
              "Sesión expirada. Vuelve a iniciar sesión.",
              "warning",
              1500
            );
            localStorage.removeItem("token");
            localStorage.removeItem("rol");
            window.location.href = "/";
            return;
          }

          if (!resp.ok) {
            const data = await resp.json().catch(() => ({}));

            await showToast(
              data.error || "No se pudo cargar el perfil",
              "error",
              2200
            );
            return;
          }

          currentUser = await resp.json();
          if (!currentRol && currentUser && currentUser.rol) {
            currentRol = currentUser.rol;
            localStorage.setItem("rol", currentRol);
          }

          renderNavByRole(currentRol);
          loadUserDataFromBackend(currentUser);
          configureRoleFieldByPermission();

          const fileInput = document.getElementById("photo-file-input");
          if (fileInput) {
            fileInput.addEventListener("change", function (e) {
              if (e.target.files && e.target.files[0]) {
                selectedPhotoFile = e.target.files[0];
                const fileNameEl = document.getElementById("file-name");
                if (fileNameEl) fileNameEl.textContent = selectedPhotoFile.name;

                const reader = new FileReader();
                reader.onload = function (e2) {
                  const preview = document.getElementById("photo-preview");
                  if (preview) preview.src = e2.target.result;
                };
                reader.readAsDataURL(selectedPhotoFile);
              }
            });
          }

          const form = document.getElementById("profile-form");
          if (form) {
            form.addEventListener("submit", function (e) {
              e.preventDefault();
              saveUserDataToBackend();
            });
          }
        } catch (err) {
          await showtoast(
            "Error de conexión al cargar tu perfil",
            "error",
            3000
          );
        }
      });

      function loadUserDataFromBackend(user) {
        if (!user) return;
        const setIf = (id, value) => {
          const el = document.getElementById(id);
          if (el) el.value = value ?? "";
        };

        setIf("id_usuario", user.id_usuario);
        setIf("nombre", user.nombre || "");
        setIf("apellidoP", user.apellidoP || "");
        setIf("apellidoM", user.apellidoM || "");
        setIf("edad", user.edad ?? "");
        setIf("email", user.email || "");
        setIf("telefono", user.telefono || "");
        setIf("rol", user.rol || "cliente");

        updateDisplay(user);
      }

      function updateDisplay(user) {
        const nombreCompleto = `${user.nombre || ""} ${user.apellidoP || ""} ${
          user.apellidoM || ""
        }`.trim();

        const displayNameEl = document.getElementById("display-name");
        if (displayNameEl)
          displayNameEl.textContent = nombreCompleto || "Ingresa tus datos";

        const displayRoleEl = document.getElementById("display-role");
        if (displayRoleEl) {
          const rolStr = user.rol || "cliente";
          displayRoleEl.textContent =
            rolStr.charAt(0).toUpperCase() + rolStr.slice(1);
        }

        const displayIdEl = document.getElementById("display-id");
        if (displayIdEl) displayIdEl.textContent = user.id_usuario || "-";

        const fotoUrl = user.foto_perfil || "/images/default-avatar.jpg";
        const fotoCompleta = fotoUrl.startsWith("http")
          ? fotoUrl
          : `${API_BASE}${fotoUrl}`;

        const profilePic = document.getElementById("profile-picture");
        const preview = document.getElementById("photo-preview");
        if (profilePic) profilePic.src = fotoCompleta;
        if (preview) preview.src = fotoCompleta;
      }

      function configureRoleFieldByPermission() {
        const rolSelect = document.getElementById("rol");
        if (!rolSelect) return;

        if (currentRol === "admin") {
          rolSelect.disabled = false;
        } else {
          rolSelect.disabled = true;
        }
      }

      function openPhotoModal() {
        const modal = document.getElementById("photo-modal");
        if (!modal) return;
        modal.style.display = "flex";
        selectedPhotoFile = null;
        const fileNameEl = document.getElementById("file-name");
        if (fileNameEl) fileNameEl.textContent = "Ningún archivo seleccionado";
        const fileInput = document.getElementById("photo-file-input");
        if (fileInput) fileInput.value = "";

        const fotoActual =
          currentUser && currentUser.foto_perfil
            ? currentUser.foto_perfil
            : "/images/default-avatar.jpg";
        const fotoCompleta = fotoActual.startsWith("http")
          ? fotoActual
          : `${API_BASE}${fotoActual}`;
        const preview = document.getElementById("photo-preview");
        if (preview) preview.src = fotoCompleta;
      }

      function closePhotoModal() {
        const modal = document.getElementById("photo-modal");
        if (!modal) return;
        modal.style.display = "none";
        selectedPhotoFile = null;
        const fileNameEl = document.getElementById("file-name");
        if (fileNameEl) fileNameEl.textContent = "Ningún archivo seleccionado";
        const fileInput = document.getElementById("photo-file-input");
        if (fileInput) fileInput.value = "";
      }

      async function uploadPhoto() {
        if (!selectedPhotoFile) {
          await showtoast(
            "Por favor, selecciona una imagen primero",
            "info",
            3000
          );
          return;
        }

        const token = getToken();
        if (!token) {
          await showtoast("Debes iniciar sesión", "info", 3000);
          window.location.href = "/";
          return;
        }

        const formData = new FormData();
        formData.append("foto", selectedPhotoFile);

        try {
          const resp = await fetch(`${API_AUTH}/perfil/foto`, {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });

          const data = await resp.json().catch(() => ({}));

          if (!resp.ok) {
            await showtoast(
              data.error || "Error al subir la foto",
              "error",
              3000
            );
            return;
          }

          currentUser.foto_perfil =
            data.foto_perfil || data.url || currentUser.foto_perfil;
          updateDisplay(currentUser);

          closePhotoModal();
          await showtoast(
            "Foto de perfil actualizada correctamente",
            "success",
            3000
          );
        } catch (err) {
          console.error("Error al subir foto:", err);
          await showtoast("Error de conexión al subir la foto", "error", 3000);
        }
      }

      async function saveUserDataToBackend() {
        const token = getToken();
        if (!token) {
          await showtoast("Debes iniciar sesión", "info", 3000);
          window.location.href = "/";
          return;
        }

        const body = {
          nombre: document.getElementById("nombre")
            ? document.getElementById("nombre").value.trim()
            : "",
          apellidoP: document.getElementById("apellidoP")
            ? document.getElementById("apellidoP").value.trim()
            : "",
          apellidoM: document.getElementById("apellidoM")
            ? document.getElementById("apellidoM").value.trim()
            : "",
          edad: (() => {
            const v = document.getElementById("edad")
              ? document.getElementById("edad").value
              : "";
            const n = parseInt(v, 10);
            return isNaN(n) ? null : n;
          })(),
          email: document.getElementById("email")
            ? document.getElementById("email").value.trim()
            : "",
          telefono: document.getElementById("telefono")
            ? document.getElementById("telefono").value.trim()
            : "",
          foto_perfil: currentUser ? currentUser.foto_perfil : null,
          rol:
            currentRol === "admin" && document.getElementById("rol")
              ? document.getElementById("rol").value
              : currentUser
              ? currentUser.rol
              : "cliente",
        };

        try {
          const resp = await fetch(`${API_AUTH}/perfil`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(body),
          });

          const data = await resp.json().catch(() => ({}));

          if (!resp.ok) {
            await showtoast(
              data.error || "No se pudo actualizar el perfil",
              "error",
              3000
            );
            return;
          }

          currentUser = {
            ...currentUser,
            ...body,
          };

          updateDisplay(currentUser);

          if (
            currentRol === "admin" &&
            currentUser.rol &&
            currentUser.rol !== currentRol
          ) {
            localStorage.setItem("rol", currentUser.rol);
            currentRol = currentUser.rol;
            configureRoleFieldByPermission();
          }

          await showtoast("Perfil actualizado correctamente", "success", 3000);
        } catch (err) {
          console.error("Error al actualizar perfil:", err);
          await showtoast(
            "Error de conexión al actualizar el perfil",
            "error",
            3000
          );
        }
      }

      function resetForm() {
        if (currentUser) {
          loadUserDataFromBackend(currentUser);
          configureRoleFieldByPermission();
        }
      }
    </script>
  </body>
</html>
