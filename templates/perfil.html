<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Barber Studio - Perfil</title>
    <link rel="stylesheet" href="/static/perfil.css" />
    <link rel="stylesheet" href="/static/alerts.css" />
  </head>
  <body>
    <header class="header">
      <div class="block">
        <img
          class="imagen-de-barberia"
          src="/images/barber.jpg"
          alt="Logo Barber Studio"
        />
      </div>
      <nav
        id="main-nav"
        class="navigation-pill-list"
        aria-label="Navegación principal"
      ></nav>
    </header>

    <main class="main-content">
      <div class="profile-container">
        <div class="profile-header">
          <div class="photo-upload">
            <img
              id="profile-picture"
              class="profile-picture"
              src="/images/avatardefault.webp"
              alt="Foto de perfil"
            />
            <button
              type="button"
              class="btn btn-secondary"
              onclick="openPhotoModal()"
            >
              Cambiar foto
            </button>
          </div>
          <div class="profile-info">
            <h1 class="profile-name" id="display-name">:</h1>
            <p class="profile-role" id="display-role">Cliente</p>
            <p class="profile-id">ID: <span id="display-id">#</span></p>
          </div>
        </div>

        <form id="profile-form" class="profile-form">
          <input type="hidden" id="id_usuario" name="id_usuario" value="" />

          <div class="form-group">
            <label for="nombre">Nombre</label>
            <input type="text" id="nombre" name="nombre" value="" />
          </div>

          <div class="form-group">
            <label for="apellidoP">Apellido Paterno</label>
            <input type="text" id="apellidoP" name="apellidoP" />
          </div>

          <div class="form-group">
            <label for="apellidoM">Apellido Materno</label>
            <input type="text" id="apellidoM" name="apellidoM" />
          </div>

          <div class="form-group">
            <label for="edad">Edad</label>
            <input type="number" id="edad" name="edad" min="7" max="100" />
          </div>

          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" />
          </div>

          <div class="form-group">
            <label for="telefono">Teléfono</label>
            <input type="tel" id="telefono" name="telefono" />
          </div>

          <div class="form-group">
            <label for="rol">Rol</label>
            <select id="rol" name="rol" required>
              <option value="cliente">Cliente</option>
              <option value="barbero">Barbero</option>
              <option value="admin">Administrador</option>
            </select>
          </div>
          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="resetForm()"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary">
              Guardar Cambios
            </button>
          </div>
        </form>
      </div>
    </main>
    <div id="photo-modal" class="modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Cambiar Foto de Perfil</h2>
          <button class="close-btn" onclick="closePhotoModal()">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="photo-preview-container">
            <img
              id="photo-preview"
              class="photo-preview"
              src="/images/avatardefault.webp"
              alt="Vista previa"
            />
          </div>
          <div class="file-input-wrapper">
            <input
              type="file"
              id="photo-file-input"
              accept="image/*"
              style="display: none"
            />
            <button
              type="button"
              class="btn btn-secondary"
              onclick="document.getElementById('photo-file-input').click()"
            >
              <i class="fa-solid fa-image"></i> Seleccionar imagen
            </button>
            <p id="file-name" class="file-name-display">
              Ningún archivo seleccionado
            </p>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            onclick="closePhotoModal()"
          >
            Cancelar
          </button>
          <button type="button" class="btn btn-primary" onclick="uploadPhoto()">
            <i class="fa-solid fa-upload"></i> Subir foto
          </button>
        </div>
      </div>
    </div>

    <div id="app-notify-root">
      <div id="app-toast-container" class="toast-container"></div>
      <div id="app-modal-container"></div>
    </div>

    <footer class="footer">
      <div class="footer-logo">
        <img
          class="imagen-de-barberia"
          src="/images/barber.jpg"
          alt="Barber Studio Logo"
        />
      </div>
      <nav class="text-link-list" aria-labelledby="footer-contact">
        <div class="text-strong-wrapper">
          <h2 id="footer-contact" class="text-strong">
            <span class="text-strong-2">contacto</span>
          </h2>
        </div>
        <ul class="footer-list">
          <li class="text-link-list-item">
            <a href="tel:9837324637" class="list-item">9837324637</a>
          </li>
          <li class="text-link-list-item">
            <a href="mailto:barberpi@utttn.mx" class="list-item-2"
              >barberpi@utttn.mx</a
            >
          </li>
        </ul>
      </nav>
      <nav class="text-link-list" aria-labelledby="footer-location">
        <div class="text-strong-wrapper">
          <h2 id="footer-location" class="text-strong">
            <span class="text-strong-2">ubicación</span>
          </h2>
        </div>
        <ul class="footer-list">
          <li class="text-link-list-item">
            <a
              href="https://maps.app.goo.gl/ZD5gur5vPiwKMVCW9?g_st=iw"
              target="_blank"
              rel="noopener noreferrer"
              class="list-item-7"
              >google.maps/micasa</a
            >
          </li>
        </ul>
      </nav>
      <nav class="text-link-list" aria-labelledby="footer-creator">
        <div class="text-strong-wrapper">
          <h2 id="footer-creator" class="text-strong">
            <span class="">creado por:</span>
          </h2>
        </div>
        <ul class="footer-list">
          <li class="text-link-list-item">
            <span class="list-item-11">Axel Rivera</span>
          </li>
          <li class="text-link-list-item">
            <span class="list-item-12">contactos:</span>
          </li>
          <li class="text-link-list-item">
            <a href="mailto:axel.delgado@uttn.mx" class="list-item-13"
              >axel.delgado@uttn.mx</a
            >
          </li>
          <li class="text-link-list-item">
            <a href="tel:8994287620" class="list-item">8994287620</a>
          </li>
        </ul>
      </nav>
    </footer>

  <script>
  const API_BASE =
    window.location.hostname.includes("localhost") ||
    window.location.hostname === "127.0.0.1"
      ? "http://localhost:4000"
      : window.location.origin;

  const API_AUTH = `${API_BASE}/api/auth`;

  function getToken() {
    return localStorage.getItem("token");
  }

  function getRol() {
    return localStorage.getItem("rol");
  }

  let currentUser = null;
  let currentRol = null;

  const nav_by_rol = {
    cliente: [
      { href: "/perfil", label: "Mi Información" },
      { href: "/home", label: "Inicio" },
      { href: "/agendar", label: "Agendar Cita" },
      { href: "/notificacion", label: "Notificaciones" },
      { href: "/", label: "Cerrar Sesión" },
    ],
    barbero: [
      { href: "/perfil", label: "Mi Información" },
      { href: "/homebarber", label: "Inicio" },
      { href: "/barber_agenda", label: "Agenda" },
      { href: "/notibarbero", label: "Notificaciones" },
      { href: "/", label: "Cerrar Sesión" },
    ],
    admin: [
      { href: "/perfil", label: "Mi Información" },
      { href: "/homebarber", label: "Inicio" },
      { href: "/barber_agenda", label: "Agenda" },
      { href: "/notibarbero", label: "Notificaciones" },
      { href: "/", label: "Cerrar Sesión" },
    ],
  };

  function renderNavByRole(role) {
    const nav = document.getElementById("main-nav");
    nav.innerHTML = "";

    (nav_by_rol[role] || nav_by_rol["cliente"]).forEach((item) => {
      const a = document.createElement("a");
      a.className = "navigation-pill";
      a.href = item.href;
      a.innerHTML = `<span class="title">${item.label}</span>`;
      nav.appendChild(a);
    });
  }

  document.addEventListener("DOMContentLoaded", async () => {
    const token = getToken();
    const rol = getRol();
    currentRol = rol;

    if (!token) {
      alert("Debes iniciar sesión");
      return (window.location.href = "/");
    }

    try {
      const resp = await fetch(`${API_AUTH}/perfil`, {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (!resp.ok) {
        alert("No se pudo cargar el perfil");
        return;
      }

      currentUser = await resp.json();

      renderNavByRole(currentRol);
      loadUserData(currentUser);
      configureRoleField();

    } catch (e) {
      console.error(e);
      alert("Error al conectar con el servidor");
    }
  });

  function loadUserData(user) {
    document.getElementById("id_usuario").value = user.id_usuario || "";
    document.getElementById("nombre").value = user.nombre || "";
    document.getElementById("apellidoP").value = user.apellidoP || "";
    document.getElementById("apellidoM").value = user.apellidoM || "";
    document.getElementById("edad").value = user.edad || "";
    document.getElementById("email").value = user.email || "";
    document.getElementById("telefono").value = user.telefono || "";
    document.getElementById("rol").value = user.rol || "cliente";

    updateDisplay(user);
  }

  function updateDisplay(user) {
    const nombreCompleto = `${user.nombre || ""} ${user.apellidoP || ""} ${user.apellidoM || ""}`.trim();

    document.getElementById("display-name").textContent =
      nombreCompleto || "Ingresa tus datos";

    document.getElementById("display-role").textContent =
      (user.rol || "cliente").charAt(0).toUpperCase() +
      (user.rol || "cliente").slice(1);

    document.getElementById("display-id").textContent = user.id_usuario || "-";

    const foto = user.foto_perfil || "/images/avatardefault.webp";

    document.getElementById("profile-picture").src = foto;
    document.getElementById("photo-preview").src = foto;
  }

  function configureRoleField() {
    const rolSelect = document.getElementById("rol");

    if (currentRol === "admin") {
      rolSelect.disabled = false;
    } else {
      rolSelect.disabled = true;
    }
  }
</script>

  </body>
</html>
