<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Barber Studio - Agendar Cita</title>
    <link rel="stylesheet" href="/static/agendar.css" />
  </head>
  <body>
    <header class="header">
      <div class="block">
        <img
          class="imagen-de-barberia"
          src="/images/barber.jpg"
          alt="Logo Barber Studio"
        />
      </div>
      <nav class="navigation-pill-list" aria-label="Navegación principal">
        <a href="/perfil" class="navigation-pill">
          <span class="title">Mi Perfil</span>
        </a>
        <a href="/home" class="navigation-pill">
          <span class="title">Inicio</span>
        </a>
        <a href="/agendar" class="navigation-pill">
          <span class="">Agendar Cita</span>
        </a>
        <a href="/notificacion" class="navigation-pill">
          <span class="title">Notificaciones</span>
        </a>
        <a href="login" class="navigation-pill" id="logout-btn">
          <span class="title">Cerrar Sesión</span>
        </a>
      </nav>
    </header>

    <main class="main-content">
      <h1 class="page-title">Agendar Cita</h1>

      <div class="booking-container">
        <section class="calendar-section">
          <div class="calendar-header">
            <div class="calendar-title" id="current-month">Septiembre 2025</div>
            <div class="calendar-nav">
              <button class="btn btn-secondary" id="prev-month">←</button>
              <button class="btn btn-secondary" id="today">Hoy</button>
              <button class="btn btn-secondary" id="next-month">→</button>
            </div>
          </div>

          <div class="calendar-grid" id="calendar">
            <!-- Los días se generarán con JavaScript -->
          </div>
        </section>

        <section class="booking-card">
          <h2 class="card-title">Selecciona tu cita</h2>

          <div
            class="selected-appointment"
            id="selected-appointment"
            style="display: none"
          >
            <div class="appointment-date" id="appointment-date">
              Sep 20, 2025
            </div>
            <div class="appointment-time" id="appointment-time">10:00 AM</div>
          </div>

          <div class="form-group">
            <label class="form-label" for="service">Servicio</label>
            <select id="service" class="form-select">
              <!-- Opciones se llenan por JS -->
              <option value="">Cargando servicios.</option>
            </select>
            <div
              id="service-price"
              style="margin-top: 0.5rem; color: #555"
            ></div>
          </div>

          <div class="form-group">
            <label class="form-label">Horarios Disponibles</label>
            <div class="time-slots" id="time-slots">
              <div
                style="
                  grid-column: 1/-1;
                  text-align: center;
                  padding: 1rem;
                  color: #888;
                "
              >
                Selecciona un día
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="notes">Notas</label>
            <textarea
              id="notes"
              class="form-textarea"
              placeholder="Especificaciones para tu corte."
            ></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Foto de Referencia</label>
            <div class="photo-upload" id="photo-upload">
              <img
                src="/images/camara-reflex-digital.png"
                width="50px"
                alt="foto"
              />
              <div>Subir foto de referencia</div>
              <input
                type="file"
                id="reference-photo"
                name="reference-photo"
                accept="image/*"
                style="display: none"
              />
            </div>
            <img
              id="photo-preview"
              class="photo-preview"
              alt="Vista previa de la foto"
              style="display: none"
            />
          </div>

          <button class="submit-btn" id="submit-booking" disabled>
            Enviar
          </button>
        </section>
      </div>
    </main>

    <footer class="footer">
      <div class="footer-logo">
        <img
          class="imagen-de-barberia"
          src="/images/barber.jpg"
          alt="Barber Studio Logo"
        />
      </div>
      <nav class="text-link-list" aria-labelledby="footer-contact">
        <div class="text-strong-wrapper">
          <h2 id="footer-contact" class="text-strong">
            <span class="text-strong-2">contacto</span>
          </h2>
        </div>
        <ul class="footer-list">
          <li class="text-link-list-item">
            <a href="tel:9837324637" class="list-item">9837324637</a>
          </li>
          <li class="text-link-list-item">
            <a href="mailto:barberpi@utttn.mx" class="list-item-2"
              >barberpi@utttn.mx</a
            >
          </li>
        </ul>
      </nav>
      <nav class="text-link-list" aria-labelledby="footer-location">
        <div class="text-strong-wrapper">
          <h2 id="footer-location" class="text-strong">
            <span class="text-strong-2">ubicación</span>
          </h2>
        </div>
        <ul class="footer-list">
          <li class="text-link-list-item">
            <a
              href="https://maps.app.goo.gl/ZD5gur5vPiwKMVCW9?g_st=iw"
              target="_blank"
              rel="noopener noreferrer"
              class="list-item-7"
              >google.maps/micasa</a
            >
          </li>
        </ul>
      </nav>
      <nav class="text-link-list" aria-labelledby="footer-creator">
        <div class="text-strong-wrapper">
          <h2 id="footer-creator" class="text-strong">
            <span class="">creado por:</span>
          </h2>
        </div>
        <ul class="footer-list">
          <li class="text-link-list-item">
            <span class="list-item-11">Axel Rivera</span>
          </li>
          <li class="text-link-list-item">
            <span class="list-item-12">contactos:</span>
          </li>
          <li class="text-link-list-item">
            <a href="mailto:axel.delgado@uttn.mx" class="list-item-13"
              >axel.delgado@uttn.mx</a
            >
          </li>
          <li class="text-link-list-item">
            <a href="tel:8994287620" class="list-item">8994287620</a>
          </li>
        </ul>
      </nav>
    </footer>

    <script>
      const API_BASE =
        window.location.hostname === "localhost"
          ? "http://localhost:4000"
          : "https://barberpi.onrender.com";
      const SINGLE_BARBER_ID = 3;

      let currentDate = new Date();
      let selectedDate = null;
      let selectedTime = null;
      let referencePhoto = null;
      let servicios = [];
      let selectedService = null;

      function getToken() {
        return localStorage.getItem("token");
      }
      function getRol() {
        return localStorage.getItem("rol");
      }

      // ========== CARGAR SERVICIOS ==========
      async function cargarServicios() {
        const token = getToken();
        const select = document.getElementById("service");
        select.innerHTML = '<option value="">Cargando servicios.</option>';

        try {
          const resp = await fetch(`${API_BASE}/servicios`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!resp.ok) {
            select.innerHTML =
              '<option value="">Error al cargar servicios</option>';
            return;
          }

          servicios = await resp.json();

          if (!servicios.length) {
            select.innerHTML =
              '<option value="">Sin servicios configurados</option>';
            return;
          }

          select.innerHTML = '<option value="">Selecciona un servicio</option>';

          servicios.forEach((s) => {
            const opt = document.createElement("option");
            opt.value = s.id_servicio; // ✅ CAMBIO: Ahora usa el ID
            opt.textContent = s.nombre;
            opt.dataset.precio = s.precio;
            opt.dataset.nombre = s.nombre; // ✅ Guardamos el nombre en data attribute
            select.appendChild(opt);
          });
        } catch (err) {
          console.error("Error al cargar servicios:", err);
          select.innerHTML =
            '<option value="">Error de conexión al cargar servicios</option>';
        }
      }

      // ========== BLOQUEO POR CITA EN 30 DÍAS ==========

      // Función auxiliar para formatear fecha (agrégala si no la tienes ya)
      function formatearFecha(fechaValor) {
        if (!fechaValor) return "";

        let str = String(fechaValor);

        // Si viene con hora (YYYY-MM-DDTHH:MM:SSZ), nos quedamos solo con la fecha
        if (str.includes("T")) {
          str = str.split("T")[0];
        }

        // Si está en formato YYYY-MM-DD la parseamos a mano
        const partes = str.split("-");
        if (partes.length === 3) {
          const [y, m, d] = partes.map(Number);
          if (!Number.isNaN(y) && !Number.isNaN(m) && !Number.isNaN(d)) {
            const fechaLocal = new Date(y, m - 1, d);
            if (!Number.isNaN(fechaLocal.getTime())) {
              return fechaLocal.toLocaleDateString("es-ES", {
                year: "numeric",
                month: "long",
                day: "numeric",
              });
            }
          }
        }

        return str;
      }
      async function verificarBloqueoCitas() {
        const token = getToken();
        const btn = document.getElementById("submit-booking");
        const container = document.querySelector(".booking-card");

        try {
          const resp = await fetch(`${API_BASE}/citas/puede-agendar`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!resp.ok) return;

          const data = await resp.json();

          if (!data.puede_agendar) {
            btn.disabled = true;
            const fechaFormateada = formatearFecha(data.cita.fecha);
            const aviso = document.createElement("div");
            aviso.style.marginTop = "1rem";
            aviso.style.color = "red";
            aviso.innerHTML = `
              Ya tienes una cita programada el <strong>${fechaFormateada}</strong> a las <strong>${data.cita.hora}</strong>.<br />
              Solo se permite una cita en los próximos 30 días.
            `;
            container.appendChild(aviso);
          }
        } catch (err) {
          console.error("Error al verificar bloqueo de citas:", err);
        }
      }

      document.addEventListener("DOMContentLoaded", async function () {
        const token = getToken();
        const rol = getRol();

        if (!token) {
          alert("Debes iniciar sesión");
          window.location.href = "/barberpi/login";
          return;
        }

        if (rol !== "cliente") {
          alert("Esta página es solo para clientes");
          window.location.href = "/barberpi/home";
          return;
        }

        await cargarServicios();
        await verificarBloqueoCitas();
        setupEventListeners();

        const todayStr = formatDate(new Date());
        generateCalendar(currentDate, todayStr);
      });

      function setupEventListeners() {
        document
          .getElementById("prev-month")
          .addEventListener("click", function () {
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar(currentDate, null);
          });

        document
          .getElementById("next-month")
          .addEventListener("click", function () {
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar(currentDate, null);
          });

        document.getElementById("today").addEventListener("click", function () {
          currentDate = new Date();
          const todayStr = formatDate(new Date());
          generateCalendar(currentDate, todayStr);
        });

        document
          .getElementById("service")
          .addEventListener("change", function () {
            selectedService = this.value;

            const priceDiv = document.getElementById("service-price");
            const opt = this.selectedOptions[0];

            if (opt && opt.dataset.precio) {
              const precio = parseFloat(opt.dataset.precio).toFixed(2);
              priceDiv.textContent = `Precio estimado: $${precio} MXN`;
            } else {
              priceDiv.textContent = "";
            }

            validateForm();
          });

        document
          .getElementById("photo-upload")
          .addEventListener("click", function () {
            document.getElementById("reference-photo").click();
          });

        document
          .getElementById("reference-photo")
          .addEventListener("change", function (e) {
            if (e.target.files && e.target.files[0]) {
              referencePhoto = e.target.files[0];
              const reader = new FileReader();
              reader.onload = function (evt) {
                const preview = document.getElementById("photo-preview");
                preview.src = evt.target.result;
                preview.style.display = "block";
              };
              reader.readAsDataURL(referencePhoto);
            }
          });

        document
          .getElementById("submit-booking")
          .addEventListener("click", function () {
            bookAppointment();
          });

        document
          .getElementById("logout-btn")
          .addEventListener("click", function (e) {
            e.preventDefault();
            localStorage.clear();
            window.location.href = "/barberpi/login";
          });
      }

      // ========== CALENDARIO ==========
      function generateCalendar(date, preselectDateStr) {
        const calendar = document.getElementById("calendar");
        calendar.innerHTML = "";

        const days = ["Dom", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb"];
        days.forEach((day) => {
          const dayHeader = document.createElement("div");
          dayHeader.className = "calendar-day-header";
          dayHeader.textContent = day;
          calendar.appendChild(dayHeader);
        });

        const monthNames = [
          "Enero",
          "Febrero",
          "Marzo",
          "Abril",
          "Mayo",
          "Junio",
          "Julio",
          "Agosto",
          "Septiembre",
          "Octubre",
          "Noviembre",
          "Diciembre",
        ];
        document.getElementById("current-month").textContent = `${
          monthNames[date.getMonth()]
        } ${date.getFullYear()}`;

        const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
        const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);
        const prevMonthLastDay = new Date(
          date.getFullYear(),
          date.getMonth(),
          0
        ).getDate();
        const startingDay = firstDay.getDay();

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        for (let i = startingDay - 1; i >= 0; i--) {
          const d = new Date(
            date.getFullYear(),
            date.getMonth() - 1,
            prevMonthLastDay - i
          );
          const el = createDayElement(d, true, today);
          calendar.appendChild(el);
        }

        for (let i = 1; i <= lastDay.getDate(); i++) {
          const d = new Date(date.getFullYear(), date.getMonth(), i);
          const el = createDayElement(d, false, today);
          calendar.appendChild(el);
        }

        const totalCells = 42;
        const usedCells = startingDay + lastDay.getDate();
        const remaining = totalCells - usedCells;

        for (let i = 1; i <= remaining; i++) {
          const d = new Date(date.getFullYear(), date.getMonth() + 1, i);
          const el = createDayElement(d, true, today);
          calendar.appendChild(el);
        }

        if (preselectDateStr) {
          selectDate(preselectDateStr);
        }
      }

      function createDayElement(dateObj, isOtherMonth, today) {
        const dayElement = document.createElement("div");
        dayElement.className = "calendar-day";

        const dateStr = formatDate(dateObj);
        dayElement.dataset.date = dateStr;

        const dateCopy = new Date(dateObj);
        dateCopy.setHours(0, 0, 0, 0);
        const isPast = dateCopy < today;

        if (isOtherMonth) {
          dayElement.classList.add("other-month");
        }

        const dayNumber = document.createElement("div");
        dayNumber.className = "calendar-day-number";
        dayNumber.textContent = dateObj.getDate();
        dayElement.appendChild(dayNumber);

        if (isPast) {
          dayElement.classList.add("unavailable");
          dayElement.style.cursor = "not-allowed";
          return dayElement;
        }

        dayElement.addEventListener("click", () => {
          if (isOtherMonth) {
            currentDate = new Date(dateObj);
            generateCalendar(currentDate, dateStr);
          } else {
            selectDate(dateStr);
          }
        });

        const todayStr = formatDate(today);
        if (dateStr === todayStr) {
          dayElement.classList.add("today");
        }

        return dayElement;
      }

      function selectDate(dateStr) {
        const prev = document.querySelector(".calendar-day.selected");
        if (prev) prev.classList.remove("selected");

        const dayEl = document.querySelector(
          `.calendar-day[data-date="${dateStr}"]`
        );
        if (dayEl && !dayEl.classList.contains("unavailable")) {
          dayEl.classList.add("selected");
          selectedDate = dateStr;
          updateTimeSlots(dateStr);
          updateSelectedAppointment();
        }
      }

      // ========== SLOTS ==========
      async function updateTimeSlots(dateStr) {
        const container = document.getElementById("time-slots");
        container.innerHTML = "";
        selectedTime = null;

        const barberoId = SINGLE_BARBER_ID;
        const token = getToken();

        try {
          const resp = await fetch(
            `${API_BASE}/horario-dia-barbero?fecha=${dateStr}&id_barbero=${barberoId}`,
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          if (!resp.ok) {
            container.innerHTML =
              '<div style="grid-column:1/-1;text-align:center;padding:1rem;color:#888;">Error al cargar horarios</div>';
            return;
          }

          const data = await resp.json();
          const slots = data.slots || [];

          if (!slots.length) {
            container.innerHTML =
              '<div style="grid-column:1/-1;text-align:center;padding:1rem;color:#888;">Día cerrado</div>';
            return;
          }

          slots.forEach((slot) => {
            const isAvailable = slot.disponible;

            const el = document.createElement("div");
            el.className = "time-slot" + (isAvailable ? "" : " unavailable");
            el.dataset.time = slot.hora;

            const [hStr, mStr] = slot.hora.split(":");
            let h = parseInt(hStr);
            const ampm = h >= 12 ? "PM" : "AM";
            h = h % 12;
            h = h === 0 ? 12 : h;
            el.textContent = `${h}:${mStr} ${ampm}`;

            if (isAvailable) {
              el.addEventListener("click", () => {
                document
                  .querySelectorAll(".time-slot.selected")
                  .forEach((t) => t.classList.remove("selected"));
                el.classList.add("selected");
                selectedTime = el.dataset.time;
                updateSelectedAppointment();
                validateForm();
              });
            }

            container.appendChild(el);
          });
        } catch (err) {
          console.error("Error al cargar slots:", err);
          container.innerHTML =
            '<div style="grid-column:1/-1;text-align:center;padding:1rem;color:#888;">Error de conexión</div>';
        }
      }

      // ========== RESUMEN CITA ==========
      function updateSelectedAppointment() {
        if (selectedDate && selectedTime) {
          const date = parseDate(selectedDate);
          const monthNames = [
            "Ene",
            "Feb",
            "Mar",
            "Abr",
            "May",
            "Jun",
            "Jul",
            "Ago",
            "Sep",
            "Oct",
            "Nov",
            "Dic",
          ];

          document.getElementById("selected-appointment").style.display =
            "block";
          document.getElementById("appointment-date").textContent = `${
            monthNames[date.getMonth()]
          } ${date.getDate()}, ${date.getFullYear()}`;

          const [hStr, mStr] = selectedTime.split(":");
          let h = parseInt(hStr);
          const ampm = h >= 12 ? "PM" : "AM";
          h = h % 12;
          h = h === 0 ? 12 : h;

          document.getElementById(
            "appointment-time"
          ).textContent = `${h}:${mStr} ${ampm}`;
        } else {
          document.getElementById("selected-appointment").style.display =
            "none";
        }
      }

      function validateForm() {
        const btn = document.getElementById("submit-booking");
        btn.disabled = !(selectedDate && selectedTime && selectedService);
      }

      // ========== ENVIAR CITA ==========
      async function bookAppointment() {
        if (!selectedDate || !selectedTime || !selectedService) {
          alert("Por favor, completa todos los campos obligatorios");
          return;
        }

        const token = getToken();

        const formData = new FormData();
        formData.append("id_barbero", SINGLE_BARBER_ID);
        formData.append("fecha", selectedDate);
        formData.append("hora", selectedTime + ":00");
        formData.append("id_servicio", selectedService);
        formData.append("notas", document.getElementById("notes").value || "");
        formData.append(
          "precio_estimado",
          calculateEstimatedPrice(selectedService)
        );

        if (referencePhoto) {
          formData.append("referencia_foto", referencePhoto);
        }

        try {
          const resp = await fetch(`${API_BASE}/citas`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });

          const data = await resp.json();

          if (!resp.ok) {
            alert(data.error || "Error al agendar cita");
            if (data.error === "Este horario ya está ocupado") {
              updateTimeSlots(selectedDate);
            }
            return;
          }

          alert("¡Cita agendada exitosamente!");

          selectedTime = null;
          document
            .querySelectorAll(".time-slot.selected")
            .forEach((t) => t.classList.remove("selected"));
          document.getElementById("notes").value = "";
          const preview = document.getElementById("photo-preview");
          preview.style.display = "none";
          preview.src = "";
          document.getElementById("reference-photo").value = "";
          referencePhoto = null;

          updateTimeSlots(selectedDate);
          updateSelectedAppointment();
          validateForm();
        } catch (err) {
          console.error("Error al enviar cita:", err);
          alert("Error de conexión");
        }
      }

      function calculateEstimatedPrice(idservicio) {
        const s = servicios.find((x) => x.id_servicio === idservicio);
        if (!s) return 0;
        return s.precio;
      }

      function formatDate(d) {
        return (
          d.getFullYear() +
          "-" +
          String(d.getMonth() + 1).padStart(2, "0") +
          "-" +
          String(d.getDate()).padStart(2, "0")
        );
      }

      function parseDate(str) {
        const [y, m, d] = str.split("-").map((n) => parseInt(n));
        return new Date(y, m - 1, d);
      }
    </script>
  </body>
</html>
